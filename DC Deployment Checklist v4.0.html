<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Deployment Checklist v6.0 (Optimized)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        /*
         * DC Deployment Checklist v6.0 CSS (Optimized based on Heuristic Evaluation)
         */
        :root{--bg-color:#1a1d24;--panel-bg:#21252e;--text-color:#c0c5ce;--text-light:#e0e7ff;--border-color:#4a5568;--accent-color:#63b3ed;--success-color:#48bb78;--error-color:#f56565;--warning-color:#f6e05e;--needs-review-color:#ed8936;--font-mono:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,Courier,monospace}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box}html,body{height:100%}body{font-family:var(--font-mono);background-color:var(--bg-color);color:var(--text-color);margin:0;padding:1rem;line-height:1.6;font-size:14px}.desktop-view{display:grid;grid-template-columns:250px 1fr 2fr;grid-template-rows:auto auto 1fr;grid-template-areas:"header header header" "controls controls controls" "sidebar overview detail";gap:1rem;height:calc(100vh - 2rem);max-width:1600px;margin:0 auto}.app-header{grid-area:header;border-bottom:1px solid var(--border-color);padding:.5rem 1rem;display:flex;justify-content:space-between;align-items:center}.header-title{font-size:1.2em;margin:0}.app-controls{grid-area:controls;display:flex;gap:1rem;align-items:center;flex-wrap:wrap}.panel{border:1px solid var(--border-color);background-color:var(--panel-bg);border-radius:8px;padding:0;overflow:hidden;height:100%;display:flex;flex-direction:column}.panel-sidebar{grid-area:sidebar}.panel-overview{grid-area:overview}.panel-detail{grid-area:detail}.panel-title{font-weight:700;color:var(--text-light);font-size:1.1em;margin:0;padding:1rem;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:.5rem;flex-shrink:0}.panel-content{overflow-y:auto;flex-grow:1;padding:1rem}.category-list,.rack-list,.equipment-list{list-style:none;padding:0;margin:0}.category-list-item{padding:.5rem;cursor:pointer;display:flex;align-items:center;gap:.75rem;transition:background-color .2s;border-radius:4px}.category-list-item:hover{background-color:rgba(255,255,255,.05)}.category-list-item.active{color:var(--accent-color);font-weight:700;background-color:rgba(99,179,237,.1)}.rack-list-item{display:flex;align-items:center;gap:.5rem}.rack-list-item-main{flex-grow:1;border:none;background:0 0;font-family:var(--font-mono);color:var(--text-color);font-size:1em;padding:.5rem;cursor:pointer;display:flex;align-items:center;gap:.75rem;transition:background-color .2s;border-radius:4px}.rack-list-item-main:hover{background-color:rgba(255,255,255,.05)}.status-icon{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:700}.status-icon.verified{background-color:var(--success-color);color:#fff}.status-icon.failed{background-color:var(--error-color);color:#fff}.status-icon.needs-review{background-color:var(--needs-review-color);color:#fff}.status-icon.in-progress{background-color:var(--accent-color);color:#fff}.status-icon.pending{border:1px solid var(--border-color);background:0 0}.rack-progress-bar{width:100%;height:16px;background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:3px;overflow:hidden}.rack-progress-fill{height:100%;background-color:var(--accent-color);transition:width .3s}.rack-list-item .rack-name{width:100px;flex-shrink:0}.rack-list-item .percentage{width:50px;text-align:right}.rack-list-item .rack-overview-devices-btn{background:0 0;border:1px solid var(--border-color);color:var(--text-color);cursor:pointer;border-radius:4px;margin-left:.5rem;padding:0 .5rem;font-size:1.1em;transition:background-color .2s,border-color .2s;flex-shrink:0}.rack-list-item .rack-overview-devices-btn:hover{background-color:var(--accent-color);border-color:var(--accent-color);color:var(--bg-color)}.equipment-list-item{background:var(--bg-color);border-radius:8px;padding:1rem;margin-bottom:12px;border:1px solid var(--border-color);box-shadow:0 2px 4px rgba(0,0,0,.1);transition:transform .2s,box-shadow .2s}.equipment-list-item:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}.equipment-header{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem}.equipment-header .title{font-weight:700;color:var(--text-light);flex-grow:1;font-size:1em;line-height:1.5;margin-bottom:4px}.equipment-details{margin-top:.5rem;padding-left:1rem;color:var(--text-color);font-size:.9em;word-break:break-all}.item-note{font-style:italic;color:var(--warning-color);margin-top:.5rem;padding:.5rem;background-color:rgba(246,224,94,.1);border-radius:4px;border-left:3px solid var(--warning-color)}.item-controls{display:flex;gap:.5rem;align-items:center}.item-control-btn{cursor:pointer;padding:.25rem;border-radius:3px;transition:background-color .2s;background:0 0;border:none;color:var(--text-color);display:flex;align-items:center;justify-content:center}.item-control-btn svg{width:20px;height:20px}.item-control-btn:hover{background-color:rgba(255,255,255,.1)}.status-select{width:150px;height:36px;font-size:14px;padding:0 8px;border-radius:4px;background:var(--bg-color);color:var(--text-color);border:1px solid var(--border-color);font-family:var(--font-mono)}.search-input{background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:.5rem;width:200px;border-radius:4px}.search-input:focus,.btn:focus-visible,.item-control-btn:focus-visible,.status-toggle:focus-visible,.rack-selector-container input:focus-visible+span{outline:2px solid var(--accent-color);outline-offset:2px}.btn{background-color:var(--accent-color);color:var(--bg-color);border:none;padding:.5rem 1rem;cursor:pointer;font-family:var(--font-mono);border-radius:4px;transition:background-color .2s;font-weight:700;display:inline-flex;align-items:center;gap:.5rem}.btn:hover{background-color:#5299d3}.btn-secondary{background-color:var(--border-color);color:var(--text-light)}.btn-secondary:hover{background-color:#5a6c7d}.btn svg{width:16px;height:16px}.rack-selector-container{padding-bottom:1rem;border-bottom:1px solid var(--border-color);margin-bottom:1rem;flex-shrink:0}.rack-selector-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem}.rack-selector-grid label{display:inline-flex;align-items:center;padding:.25rem .5rem;cursor:pointer;border-radius:3px;transition:background-color .2s}.rack-selector-grid label:hover{background-color:rgba(255,255,255,.05)}.rack-selector-grid input{margin-right:.5rem}.no-selection{display:flex;align-items:center;justify-content:center;height:100%;color:var(--border-color);font-style:italic}.detail-rack-group h3{font-size:1em;display:flex;align-items:center;justify-content:space-between}.detail-rack-group .rack-controls{display:flex;gap:.5rem}.detail-rack-group-title{display:flex;align-items:center;gap:.5rem;cursor:pointer}.rack-control-btn{background-color:var(--panel-bg);color:var(--text-color);border:1px solid var(--border-color);padding:.25rem .5rem;border-radius:4px;font-size:.9em;cursor:pointer;transition:background-color .2s;font-weight:700;display:flex;align-items:center;gap:.25rem}.rack-control-btn:hover{background-color:var(--accent-color);color:var(--bg-color);border-color:var(--accent-color)}.rack-control-btn svg{width:14px;height:14px}.progress-stats{display:flex;gap:1rem;padding:.5rem;background-color:var(--bg-color);border-radius:4px;margin-bottom:1rem;font-size:.9em}.progress-stats span{display:flex;align-items:center;gap:.25rem}.mobile-view{display:none}.offline-indicator{position:fixed;top:10px;right:10px;background-color:var(--error-color);color:#fff;padding:.5rem;border-radius:4px;display:none;z-index:3000}.offline-indicator.show{display:block}.notification{position:fixed;top:20px;right:20px;padding:1rem;border-radius:4px;color:#fff;font-family:var(--font-mono);z-index:1000;transform:translateX(calc(100% + 20px));transition:transform .3s ease-in-out}.notification.show{transform:translateX(0)}.notification.success{background-color:var(--success-color)}.notification.error{background-color:var(--error-color)}.notification.info{background-color:var(--accent-color)}.modal-overlay,.search-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility 0s .3s}.modal-overlay.is-visible,.search-overlay.is-visible{opacity:1;visibility:visible;transition:opacity .3s ease}.modal-overlay{background-color:rgba(0,0,0,.7)}.search-overlay{background-color:rgba(0,0,0,.9);flex-direction:column;padding:1rem}.modal-content{background-color:var(--panel-bg);border:1px solid var(--border-color);border-radius:8px;width:100%;max-width:800px;max-height:90vh;display:flex;flex-direction:column}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--border-color);flex-shrink:0}.modal-header h2{margin:0;color:var(--text-light);font-size:1.1em}.modal-close-btn{background:0 0;border:none;color:var(--text-color);font-size:2rem;cursor:pointer;line-height:1}.modal-body{overflow-y:auto;padding:1rem}.modal-body .form-group{margin-bottom:1rem}.modal-body label{display:block;margin-bottom:.5rem;color:var(--text-light)}.modal-body input,.modal-body textarea{width:100%;background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:.75rem;border-radius:4px;font-size:1rem;font-family:var(--font-mono)}.modal-body textarea{min-height:120px;resize:vertical}.modal-footer{padding:1rem;border-top:1px solid var(--border-color);text-align:right;display:flex;justify-content:flex-end;gap:.5rem;flex-shrink:0}.device-data-group{margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.device-data-group:last-child{border-bottom:none}.device-data-group h3{color:var(--accent-color);margin:0 0 1rem;font-size:1em}.instructions-modal details{border:1px solid var(--border-color);border-radius:4px;margin-bottom:1rem}.instructions-modal summary{padding:1rem;cursor:pointer;background-color:var(--bg-color);color:var(--text-light);font-weight:700}.instructions-modal details[open] summary{border-bottom:1px dashed var(--border-color)}.instructions-modal ol{list-style-type:decimal;padding-left:2rem;margin:1rem 0}.instructions-modal li{margin-bottom:.75rem}.instructions-modal li strong{color:var(--accent-color)}.instructions-modal li .note{display:block;font-size:.9em;color:var(--warning-color);margin-top:.25rem;padding-left:1rem;border-left:2px solid var(--warning-color);white-space:pre-wrap}.search-overlay__header{display:flex;gap:1rem;margin-bottom:1rem}.search-overlay__input{flex-grow:1;background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:.75rem;border-radius:4px;font-size:1.1rem}.search-overlay__input:focus{outline:none;border-color:var(--accent-color)}.breadcrumb{margin:0 0 .5rem;padding:0}.breadcrumb ol{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0}.breadcrumb li a{color:var(--accent-color);text-decoration:none}.breadcrumb li a:hover{text-decoration:underline}.breadcrumb .breadcrumb-separator{margin:0 .5rem;color:var(--border-color)}.btn.loading{position:relative;pointer-events:none;color:transparent!important}.btn.loading::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;border:2px solid var(--bg-color);border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}mark{background-color:var(--warning-color);color:var(--bg-color);padding:0 2px;border-radius:2px}@media (max-width:768px){.desktop-view{display:none}.mobile-view{display:flex;flex-direction:column;height:calc(100vh - 1rem);border:1px solid var(--border-color);background-color:var(--panel-bg);border-radius:8px}.modal-content{max-width:100%;height:100%;border-radius:0;max-height:100vh}body{padding:.5rem}.mobile-panel{display:none;flex-direction:column;height:100%}.mobile-panel.active{display:flex}.mobile-header{padding:.75rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;font-size:1.1rem;flex-shrink:0}.mobile-panel-content{overflow-y:auto;flex-grow:1;padding:1rem}.mobile-back-btn{cursor:pointer;color:var(--accent-color);background:0 0;border:none;font-size:1.1rem;font-family:var(--font-mono);padding:0}.mobile-rack-item{display:flex;align-items:center;gap:.5rem;padding:.75rem;font-size:1.1rem;border-bottom:1px solid var(--border-color);cursor:pointer}.mobile-main-category-header{background-color:var(--bg-color);color:var(--accent-color);padding:.5rem .75rem;font-weight:700;margin-top:.5rem;border-radius:4px;border-bottom:1px solid var(--accent-color)}.mobile-main-list .mobile-rack-item:hover{background-color:rgba(255,255,255,.05)}.mobile-toolbar{padding:1rem;border-top:1px solid var(--border-color);display:flex;justify-content:space-around;align-items:center;font-size:1.2rem;flex-shrink:0}.mobile-toolbar .btn{min-width:40px;padding:.75rem}.mobile-equipment-item{border:1px solid var(--border-color);margin-bottom:1rem;padding:1rem;border-radius:8px;background-color:var(--bg-color)}.mobile-equipment-header{display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;margin-bottom:.5rem}.mobile-equipment-title{font-weight:700;color:var(--text-light);flex-grow:1;font-size:1rem}.mobile-equipment-controls{display:flex;gap:.5rem;align-items:center}.mobile-toolbar .btn:active,.mobile-rack-item:active,.mobile-status-toggle:active,.note-btn:active,.data-btn:active,.photo-btn:active,.rack-devices-btn:active,.rack-overview-devices-btn:active{transform:scale(.96);background-color:rgba(255,255,255,.1)}}@media print{body{background-color:#fff;color:#000;padding:0;margin:0}.desktop-view{display:block;grid-template-columns:1fr;height:auto}.app-header,.app-controls,.panel-sidebar,.panel-overview,.modal-overlay,.offline-indicator{display:none!important}.panel{border:none;background-color:#fff;height:auto}.panel-detail{grid-area:initial}.panel-title{color:#000;border-bottom:2px solid #000}.equipment-list-item{box-shadow:none;border:1px solid #ccc;page-break-inside:avoid}.equipment-header .title{color:#000}.equipment-details{color:#333}.item-controls,.rack-controls{display:none!important}.item-note{color:#555;background-color:#eee;border-left-color:#aaa}}
    </style>
</head>
<body>
    <div class="offline-indicator" id="offline-indicator" role="status" aria-live="polite">
        📶 Working Offline
    </div>

    <div class="desktop-view">
        <header class="app-header" role="banner">
            <h1 class="header-title">📊 DC Deployment Checklist v6.0</h1>
            <div class="header-user"><span>DataCenter-1</span> | <span>Admin</span></div>
        </header>

        <div class="app-controls" role="search">
            <nav id="breadcrumb-container" class="breadcrumb" aria-label="Breadcrumb"></nav>
            <input type="search" id="search-input" class="search-input" placeholder="Search equipment..." aria-label="Search equipment, cables, racks">
            <button class="btn" id="show-instructions-btn"></button>
            <button class="btn" id="export-yaml-btn"></button>
            <button class="btn" id="export-csv-btn"></button>
            <button class="btn btn-secondary" id="import-btn"></button>
            <button class="btn btn-secondary" id="backup-btn"></button>
            <button class="btn btn-secondary" id="reset-all-btn"></button>
        </div>

        <aside class="panel panel-sidebar" role="navigation">
            <h2 class="panel-title">📋 Categories</h2>
            <div class="panel-content">
                <div class="progress-stats" id="overall-stats"></div>
                <ul id="category-list" class="category-list"></ul>
            </div>
        </aside>

        <main class="panel panel-overview" role="region" aria-labelledby="overview-title">
            <h2 class="panel-title" id="overview-title">📊 Rack Overview</h2>
            <div class="panel-content">
                <div id="rack-selector" class="rack-selector-container"></div>
                <ul id="rack-overview-list" class="rack-list"></ul>
            </div>
        </main>

        <section class="panel panel-detail" role="region" aria-labelledby="detail-panel-title">
            <h2 class="panel-title" id="detail-panel-title">🔧 Equipment Detail</h2>
            <div class="panel-content" id="equipment-detail-content"></div>
        </section>
    </div>

    <div class="mobile-view" id="mobile-view">
        <div id="mobile-panel-main" class="mobile-panel active">
             <header class="mobile-header">
                <span>🏢 DC-1</span>
                <button class="btn btn-secondary" id="mobile-filter-racks-btn" style="padding: 0.25rem 0.5rem; font-size: 0.9em;">Filter Racks</button>
                <span id="mobile-total-progress"></span>
            </header>
            <div class="mobile-panel-content">
                <ul id="mobile-main-list" class="category-list"></ul>
            </div>
            <footer class="mobile-toolbar">
                <button class="btn" id="mobile-show-instructions-btn" title="Instructions"></button>
                <button class="btn" id="mobile-export-yaml-btn" title="Export YAML">YAML</button>
                <button class="btn" id="mobile-export-csv-btn" title="Export CSV">CSV</button>
                <button class="btn btn-secondary" id="mobile-search-btn" title="Search"></button>
                <button class="btn btn-secondary" id="mobile-backup-btn" title="Backup"></button>
                <button class="btn btn-secondary" id="mobile-reset-all-btn" title="Reset All"></button>
            </footer>
        </div>

        <div id="mobile-panel-items" class="mobile-panel">
            <header class="mobile-header">
                <button class="mobile-back-btn" aria-label="Go back to main list">← Back</button>
                <h2 id="mobile-item-title" style="font-size: 1.1em; margin: 0;"></h2>
            </header>
            <div class="mobile-panel-content" id="mobile-item-list"></div>
        </div>
    </div>
    
    <div id="app-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <header class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close-btn" aria-label="Close modal">&times;</button>
            </header>
            <div id="modal-body" class="modal-body"></div>
            <footer id="modal-footer" class="modal-footer"></footer>
        </div>
    </div>
    
    <div id="search-overlay" class="search-overlay">
        <div class="search-overlay__header">
            <input type="search" id="mobile-search-input" class="search-overlay__input" placeholder="Search everything...">
            <button id="close-search-overlay-btn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <script>
    /**
     * @file Data Center Interactive Checklist Application v6.0 (Optimized)
     * @description A standalone, client-side web application for tracking data center deployment tasks.
     * v6.0 implements significant UX/UI and architectural improvements based on a heuristic evaluation.
     * Key changes: direct status selection, improved visual design, robust error handling,
     * and enhanced navigation.
     *
     * @author Gemini AI Code Auditor & Implementer
     * @version 6.0
     * @license MIT
     */
    (function() {
        'use strict';

        // #region ICONS
        const icons = {
            instructions: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Instructions`,
            yaml: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg> YAML`,
            csv: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M5 13H3.5v-.4L5.3 10H3.5v-.7h2.3v.4L4.2 12H6v.3h-.7V13H5zm4.8 0H8v-3h1.8c.4 0 .8.1 1 .3s.3.4.3.7c0 .3-.1.5-.3.7s-.5.3-1 .3H8.8v1zm-.7-1.3h.7c.3 0 .5-.1.7-.2.2-.1.3-.3.3-.5s-.1-.4-.3-.5-.4-.2-.7-.2h-.7v1.4zm4.2.3c.3.2.7.3 1.2.3.5 0 .9-.1 1.2-.3.3-.2.5-.5.5-.9s-.2-.7-.5-.9-.7-.3-1.2-.3c-.5 0-.9.1-1.2.3-.3.2-.5.5-.5.9s.2.7.5.9zm-.8-1.7c.3-.2.6-.3 1-.3.4 0 .7.1 1 .3.2.2.4.4.4.7s-.1.5-.4.7c-.2.2-.6.3-1 .3-.4 0-.7-.1-1-.3-.2-.2-.4-.4-.4-.7s.1-.5.4-.7z"/></svg> CSV`,
            import: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg> Import`,
            backup: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Backup`,
            reset: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg> Reset`,
            note: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-2 14h-2v-2h2v2zm0-4h-2v-4h2v4z"></path></svg>`,
            data: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-4h2v4zm4 0h-2v-4h2v4zm4 0h-2v-4h2v4zm0-6H7V7h10v4z"></path></svg>`,
            devices: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"></path></svg>`,
            photo: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>`
        };
        // #endregion

        // #region DATA
        const deploymentInstructionsData = [
            {
                phase: 'Phase 1: Physical Infrastructure Setup',
                steps: [
                    {
                        title: 'Step 1: Rack Installation',
                        note: 'Install all racks in their designated positions.\nLayout Rule: N-type racks followed by IT-type racks in each row.\nDefault: Two-row arrangements at every data center site (single-row possible but not recommended).'
                    },
                    {
                        title: 'Step 2: CPL Cabinet Installation (Optional)',
                        note: 'If CPL exists: Install the CPL (Cable Patching Location) cabinet with all its modules.'
                    },
                    {
                        title: 'Step 3: Mounting Rail Adjustment',
                        note: 'Adjust internal mounting rails within the racks to their proper positions to accommodate equipment.'
                    },
                    {
                        title: 'Step 4: ODF Module Installation (Optional)',
                        note: 'If ODF exists: Install all ODF (Optical Distribution Frame) modules into the racks.'
                    },
                    {
                        title: 'Step 5: Backbone Fiber Optic Cable Installation (Optional)',
                        note: 'If CPL exists:\n    - Install all backbone fiber optic cables (spliced or breakout) between the CPL and Meet-Me-Rooms (MMR).\n    - Install breakout fiber optic cables between the CPL and each rack ODF.\nCrucial: All backbone fiber optic cables must be measured, and measurement data documented.'
                    },
                    {
                        title: 'Step 6: PDU Socket Lock Installation (Optional)',
                        note: 'If Rittal PDUs (Power Distribution Units) are used: Install socket locks on PDUs at all planned power connector positions.\nReference: PDU power connection details are in each rack layout sheet in Annex 4.'
                    }
                ]
            },
            {
                phase: 'Phase 2: Equipment Installation and Cabling',
                steps: [
                    {
                        title: 'Step 7: Network Device Installation',
                        note: 'Install all network devices.\nRecord: Essential technical information (e.g., serial numbers, MAC addresses) in Annex 4.\nExamples of Devices: SPINE (Cisco Nexus 9336C-FX2), OAM FW (Juniper SRX1500), OAM AGG (Cisco Nexus 93180YC-FX3H), TOR BL (Cisco Nexus 93180YC-FX3H), TOR SW A/B (Cisco Nexus 93180YC-FX3H/FX3), BOR SW A/B (Cisco Nexus 92348GC-X), Console Server (Perle IOLAN SCS16C).'
                    },
                    {
                        title: 'Step 8: Server Installation',
                        note: 'Install all servers.\nRecord: Crucial technical information (e.g., serial numbers, ILO (Integrated Lights-Out) passwords) in Annex 4.\nExamples of Servers: Lenovo SR650 v3, Lenovo SR650 v2.'
                    },
                    {
                        title: 'Step 9: Device Labeling',
                        note: 'Label every installed device according to the specifications in each rack layout sheet.'
                    },
                    {
                        title: 'Step 10: Cable Labeling',
                        note: 'Label all UTP cables and fiber optic patch cables.\nOptional: Labeling DAC (Direct Attach Copper) cables.'
                    },
                    {
                        title: 'Step 11: Power Cord Installation',
                        note: 'Install power cords for every device.\nCrucial: Use socket locks (from Step 6) to secure power cords.'
                    },
                    {
                        title: 'Step 12: Fiber Optic Patch Cable Installation',
                        note: 'Install all fiber optic patch cables (e.g., CZ-FO00001).\nRegister: Cable IDs in the "FO Connections" sheet of Annex 4.'
                    },
                    {
                        title: 'Step 13: DAC Cable Installation',
                        note: 'Install all DAC cables (25G-25G 3m) between servers and TOR (Top of Rack) switches.'
                    },
                    {
                        title: 'Step 14: UTP Patch Cable Installation',
                        note: 'Install all UTP (RJ-45) patch cables.\n    - UTP Red Cable: For console connections.\n    - UTP Yellow Cable: For OAM1 connections.\n    - UTP Blue Cable: For ILO connections.\nRegister: Cable IDs in the "UTP OAM Connections" and "UTP Console Connections" sheets of Annex 4.'
                    }
                ]
            },
            {
                phase: 'Phase 3: Verification and Initial Configuration',
                steps: [
                    {
                        title: 'Step 15: Connection Verification',
                        note: 'Check every established connection.\nIndicator: Network and server equipment ports should display a blinking green light to confirm proper connectivity.'
                    },
                    {
                        title: 'Step 16: Disk Layout Application',
                        note: 'Apply the specified disk layout to Lenovo ThinkSystem SR650 v3 Servers.\nIf discrepancies are found: Swap disks in the front docking slots.\nDisk Layouts:\n    - CN (6.3/6.6): Slot 0 (960 GB), Slot 1 (960 GB), Slot 4 (3.2T), Slot 5 (3.2T)\n    - MN (6.5): Slot 0 (960 GB), Slot 1 (960 GB), Slot 4 (3.2T), Slot 5 (3.2T)\n    - SN (6.4): Slot 0 (3.2T), Slot 1 (3.2T), Slot 2 (3.2T), Slot 3 (3.2T), Slot 4 (960 GB), Slot 5 (960 GB), Slot 6 (3.2T), Slot 7 (3.2T), Slot 8 (3.2T), Slot 9 (3.2T)'
                    },
                    {
                        title: 'Step 17: Initial Server IMM Configuration',
                        note: '1. Connect keyboard and monitor to the server.\n2. Enter BIOS (typically F1 key).\n3. Set ILO/IMM (Integrated Management Module) network configuration (IP, Gateway, Mask) as defined below:\n    - Rack C01: IP: 100.85.30.x (x = rack unit position), Mask: 255.255.255.0, GW: 100.85.30.254\n    - Rack C02: IP: 100.85.40.x, Mask: 255.255.255.0, GW: 100.85.40.254\n    - Rack C03: IP: 100.85.50.x, Mask: 255.255.255.0, GW: 100.85.50.254\n    - Rack C04: IP: 100.85.60.x, Mask: 255.255.255.0, GW: 100.85.60.254\n    - Rack C05: IP: 100.85.70.x, Mask: 255.255.255.0, GW: 100.85.70.254\n    - Rack C06: IP: 100.85.80.x, Mask: 255.255.255.0, GW: 100.85.80.254\n4. Log out of BIOS.\n5. Report any hardware issues.\n6. Connect to ILO, change ILO password (User: USERID, Pass: -), and log out.'
                    },
                    {
                        title: 'Step 18: Infra1 Node Initial Bootstrap',
                        note: '1. Connect to ILO using a cable from a laptop.\n2. Log in.\n3. Map the Ubuntu 20.04.6-live-server-amd64.iso image as a virtual CD-ROM.\n4. Set the boot order to "1. cd-rom".\n5. Reboot the server.\n6. Install the operating system.\n7. Set network configuration (IP, GW, mask - details TBD by local service provider).\n8. Check hardware status.\n9. Verify Internet/external connectivity.\n10. Create a user: username=ubuntu, password=uTnUbU (with sudo rights).\n11. Execute `apt update && apt upgrade`.\n12. Log out.\n13. Notify the responsible engineer (share external IP, name, password).'
                    }
                ]
            }
        ];
        
        const definitiveDeviceList = {
            "C1 (N-MCS)": ["ODF (C1.47)", "Spine (C1.43)", "OAM FW (C1.42)", "AGG SW (C1.41)", "TOR_SW_BL (C1.39)", "TOR_SW_A (C1.37)", "TOR_SW_B (C1.35)", "BOR_SW_A (C1.4)", "BOR_SW_B (C1.2)", "Console Server (C1.3)", "PDU A (C1.PDU A)", "PDU B (C1.PDU B)", "Server (C1.20)", "Server (C1.18)", "Server (C1.16)", "Server (C1.14)", "Server (C1.12)", "Server (C1.10)", "Server (C1.8)", "Server (C1.6)"],
            "C2 (N-MCS)": ["ODF (C2.47)", "Spine (C2.43)", "OAM FW (C2.42)", "AGG SW (C2.41)", "TOR_SW_BL (C2.39)", "TOR_SW_A (C2.37)", "TOR_SW_B (C2.35)", "BOR_SW_A (C2.4)", "BOR_SW_B (C2.2)", "Console Server (C2.3)", "PDU A (C2.PDU A)", "PDU B (C2.PDU B)", "Server (C2.20)", "Server (C2.18)", "Server (C2.16)", "Server (C2.14)", "Server (C2.12)", "Server (C2.10)", "Server (C2.8)", "Server (C2.6)"],
            "C3 (MCS)": ["ODF (C3.47)", "TOR_SW_A (C3.45)", "TOR_SW_B (C3.43)", "BOR_SW_A (C3.4)", "BOR_SW_B (C3.2)", "PDU A (C3.PDU A)", "PDU B (C3.PDU B)", "Server (C3.20)", "Server (C3.18)", "Server (C3.16)", "Server (C3.14)", "Server (C3.12)", "Server (C3.10)", "Server (C3.8)", "Server (C3.6)"],
            "C4 (CS)": ["ODF (C4.47)", "TOR_SW_A (C4.45)", "TOR_SW_B (C4.43)", "BOR_SW_A (C4.4)", "BOR_SW_B (C4.2)", "PDU A (C4.PDU A)", "PDU B (C4.PDU B)", "Server (C4.22)", "Server (C4.20)", "Server (C4.18)", "Server (C4.16)", "Server (C4.14)", "Server (C4.12)", "Server (C4.10)", "Server (C4.8)", "Server (C4.6)"],
            "C5 (CS)": ["ODF (C5.47)", "TOR_SW_A (C5.45)", "TOR_SW_B (C5.43)", "BOR_SW_A (C5.4)", "BOR_SW_B (C5.2)", "PDU A (C5.PDU A)", "PDU B (C5.PDU B)", "Server (C5.22)", "Server (C5.20)", "Server (C5.18)", "Server (C5.16)", "Server (C5.14)", "Server (C5.12)", "Server (C5.10)", "Server (C5.8)", "Server (C5.6)"],
            "C6 (CS)": ["ODF (C6.47)", "TOR_SW_A (C6.45)", "TOR_SW_B (C6.43)", "BOR_SW_A (C6.4)", "BOR_SW_B (C6.2)", "PDU A (C6.PDU A)", "PDU B (C6.PDU B)", "Server (C6.22)", "Server (C6.20)", "Server (C6.18)", "Server (C6.16)", "Server (C6.14)", "Server (C6.12)", "Server (C6.10)", "Server (C6.8)", "Server (C6.6)"]
        };


        const fullRawData = {
            "C1 (N-MCS)": {
                "SFP Installation Verification": ["SPINE (C1.43) Ports 1-14: QSFP-100G-SM-SR", "OAM FW (C1.42) Port 15: SRX-SFP-1GE-LX (xconnect FW C2.42)", "OAM FW (C1.42) Ports 16-17: SRX-SFP-10GE-LR (to TOR BL C1.39)", "OAM FW (C1.42) HA CONTROL: SRX-SFP-1GE-LX (xconnect FW C2.42)", "OAM AGG (C1.41) Ports 1-6: GLC-LH-SMD", "OAM AGG (C1.41) Ports 47-48: SFP-10G-LR-S (xconnect AGG C2.41)", "TOR BL (C1.39) Ports 47-48: SFP-10G-LR-S (to FW C1.42)", "TOR BL (C1.39) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR BL (C1.39) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR BL (C1.39) Port 51: QSFP-100G-LR4-S (NatCo primary NNI link)", "TOR BL (C1.39) Ports 53-54: QSFP-100G-SM-SR (xconnect TORs C2.39)", "TOR (C1.37) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C1.37) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C1.37) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C1.35)", "TOR (C1.35) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C1.35) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C1.35) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C1.37)", "BOR (C1.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C1.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C1.2)", "BOR (C1.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C1.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C1.4)"],
                "Fiber Optic (FO) Connections": ["SPINE 1 (C1.43) Port 1 -> TOR BL 1 (C1.39) Port 49 (Cable: PL-FO00001)", "SPINE 1 (C1.43) Port 2 -> TOR BL 2 (C2.39) Port 49 (Cable: PL-FO00002)", "SPINE 1 (C1.43) Port 3 -> TOR A (C1.37) Port 49 (Cable: PL-FO00003)", "SPINE 1 (C1.43) Port 4 -> TOR B (C1.35) Port 49 (Cable: PL-FO00004)", "SPINE 1 (C1.43) Port 5 -> TOR A (C2.37) Port 49 (Cable: PL-FO00005)", "SPINE 1 (C1.43) Port 6 -> TOR B (C2.35) Port 49 (Cable: PL-FO00006)", "SPINE 1 (C1.43) Port 7 -> TOR A (C3.45) Port 49 (Cable: PL-FO00007)", "SPINE 1 (C1.43) Port 8 -> TOR B (C3.43) Port 49 (Cable: PL-FO00008)", "SPINE 1 (C1.43) Port 9 -> TOR A (C4.45) Port 49 (Cable: PL-FO00009)", "SPINE 1 (C1.43) Port 10 -> TOR B (C4.43) Port 49 (Cable: PL-FO00010)", "SPINE 1 (C1.43) Port 11 -> TOR A (C5.45) Port 49 (Cable: PL-FO00011)", "SPINE 1 (C1.43) Port 12 -> TOR B (C5.43) Port 49 (Cable: PL-FO00012)", "SPINE 1 (C1.43) Port 13 -> TOR A (C6.45) Port 49 (Cable: PL-FO00013)", "SPINE 1 (C1.43) Port 14 -> TOR B (C6.43) Port 49 (Cable: PL-FO00014)", "FW 1 (C1.42) Port 15 -> FW 2 (C2.42) Port 15 (Cable: PL-FO00015)", "FW 1 (C1.42) Port 16 -> TOR BL 1 (C1.39) Port 47 (Cable: PL-FO00016)", "FW 1 (C1.42) Port 17 -> TOR BL 1 (C1.39) Port 48 (Cable: PL-FO00017)", "FW 1 (C1.42) HA CONTROL -> FW 2 (C2.42) HA CONTROL (Cable: PL-FO00018)", "AGG 1 (C1.41) Port 1 -> BOR A (C1.4) Port 49 (Cable: PL-FO00019)", "AGG 1 (C1.41) Port 2 -> BOR B (C2.2) Port 49 (Cable: PL-FO00020)", "AGG 1 (C1.41) Port 3 -> BOR A (C3.4) Port 49 (Cable: PL-FO00021)", "AGG 1 (C1.41) Port 4 -> BOR B (C4.2) Port 49 (Cable: PL-FO00022)", "AGG 1 (C1.41) Port 5 -> BOR A (C5.4) Port 49 (Cable: PL-FO00023)", "AGG 1 (C1.41) Port 6 -> BOR B (C6.2) Port 49 (Cable: PL-FO00024)", "AGG 1 (C1.41) Port 47 -> AGG 2 (C2.41) Port 47 (Cable: PL-FO00025)", "AGG 1 (C1.41) Port 48 -> AGG 2 (C2.41) Port 48 (Cable: PL-FO00026)", "TOR BL 1 (C1.39) Port 51 -> NatCo NNI link (Cable: PL-FO00049)"],
                "UTP OAM Connections": ["Spine (C1.43) MGMT -> BOR SW A, Port 46", "FW (C1.42) MGMT -> BOR SW A, Port 44", "AGG SW (C1.41) MGMT -> BOR SW A, Port 43", "TOR_SW_BL (C1.39) MGMT -> BOR SW A, Port 42", "TOR_SW_A (C1.37) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C1.35) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C1.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C1.2) MGMT -> BOR SW A, Port 45", "PDU A (C1.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C1.PDU B) MGMT -> BOR SW B, Port 48", "C1.20 Server ILO -> BOR SW A, Port 32", "C1.18 Server ILO -> BOR SW A, Port 31", "C1.16 Server ILO -> BOR SW A, Port 30", "C1.14 Server ILO -> BOR SW A, Port 29", "C1.12 Server ILO -> BOR SW A, Port 28", "C1.10 Server ILO -> BOR SW A, Port 27", "C1.8 Server ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "C1.6 Server ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "UTP Console Connections": ["Console Server (C1.3) Eth1 -> BOR A (C1.2), Port 41", "Console Server (C1.3) Port 1 -> SPINE (C1.43), CON", "Console Server (C1.3) Port 2 -> FW (C1.42), CON", "Console Server (C1.3) Port 3 -> AGG (C1.41), CON", "Console Server (C1.3) Port 4 -> TOR BL (C1.39), CON"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "Spine (C1.43) (N9K-C9336C-FX2): RU 43, PDU A 18, PDU B 18", "FW (C1.42) (SRX1500-AC): RU 42, PDU A 8, PDU B 8", "AGG SW (C1.41) (N9K-C93180YC-FX3H): RU 41, PDU A 27, PDU B 27", "TOR_SW_BL (C1.39) (N9K-C93180YC-FX3H): RU 39, PDU A 17, PDU B 17", "TOR_SW_A (C1.37) (N9K-C93180YC-FX3H): RU 37, PDU A 7, PDU B 7", "TOR_SW_B (C1.35) (N9K-C93180YC-FX3H): RU 35, PDU A 26, PDU B 26", "BOR_SW_A (C1.4) (N9K-C92348GC-X): RU 4, PDU A 21, PDU B 21", "BOR_SW_B (C1.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C1.20) (Lenovo SR650 v3): RU 21, PDU A 14, PDU B 14", "Server (C1.18) (Lenovo SR650 v3): RU 19, PDU A 4, PDU B 4", "Server (C1.16) (Lenovo SR650 v3): RU 17, PDU A 23, PDU B 23", "Server (C1.14) (Lenovo SR650 v3): RU 15, PDU A 13, PDU B 13", "Server (C1.12) (Lenovo SR650 v3): RU 13, PDU A 3, PDU B 3", "Server (C1.10) (Lenovo SR650 v3): RU 11, PDU A 22, PDU B 22", "Server (C1.8) (Lenovo SR650 v3): RU 9, PDU A 12, PDU B 12", "Server (C1.6) (Lenovo SR650 v3): RU 7, PDU A 2, PDU B 2"]
            },
            "C2 (N-MCS)": {
                "SFP Installation Verification": ["SPINE (C2.43) Ports 1-14: QSFP-100G-SM-SR", "OAM FW (C2.42) Port 15: SRX-SFP-1GE-LX (xconnect FW C1.42)", "OAM FW (C2.42) Ports 16-17: SRX-SFP-10GE-LR (to TOR BL C2.39)", "OAM FW (C2.42) HA CONTROL: SRX-SFP-1GE-LX (xconnect FW C1.42)", "OAM AGG (C2.41) Ports 1-6: GLC-LH-SMD", "OAM AGG (C2.41) Ports 47-48: SFP-10G-LR-S (xconnect AGG C1.41)", "TOR BL (C2.39) Ports 47-48: SFP-10G-LR-S (to FW C2.42)", "TOR BL (C2.39) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR BL (C2.39) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR BL (C2.39) Port 51: QSFP-100G-LR4-S (NatCo primary NNI link)", "TOR BL (C2.39) Ports 53-54: QSFP-100G-SM-SR (xconnect TORs C1.39)", "TOR (C2.37) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C2.37) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C2.37) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C2.35)", "TOR (C2.35) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C2.35) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C2.35) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C2.37)", "BOR (C2.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C2.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C2.2)", "BOR (C2.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C2.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C2.4)"],
                "Fiber Optic (FO) Connections": ["SPINE 2 (C2.43) Port 1 -> TOR BL 2 (C2.39) Port 50 (Cable: PL-FO00027)", "SPINE 2 (C2.43) Port 2 -> TOR BL 1 (C1.39) Port 50 (Cable: PL-FO00028)", "SPINE 2 (C2.43) Port 3 -> TOR A (C1.37) Port 50 (Cable: PL-FO00029)", "SPINE 2 (C2.43) Port 4 -> TOR B (C1.35) Port 50 (Cable: PL-FO00030)", "SPINE 2 (C2.43) Port 5 -> TOR A (C2.37) Port 50 (Cable: PL-FO00031)", "SPINE 2 (C2.43) Port 6 -> TOR B (C2.35) Port 50 (Cable: PL-FO00032)", "SPINE 2 (C2.43) Port 7 -> TOR A (C3.45) Port 50 (Cable: PL-FO00033)", "SPINE 2 (C2.43) Port 8 -> TOR B (C3.43) Port 50 (Cable: PL-FO00034)", "SPINE 2 (C2.43) Port 9 -> TOR A (C4.45) Port 50 (Cable: PL-FO00035)", "SPINE 2 (C2.43) Port 10 -> TOR B (C4.43) Port 50 (Cable: PL-FO00036)", "SPINE 2 (C2.43) Port 11 -> TOR A (C5.45) Port 50 (Cable: PL-FO00037)", "SPINE 2 (C2.43) Port 12 -> TOR B (C5.43) Port 50 (Cable: PL-FO00038)", "SPINE 2 (C2.43) Port 13 -> TOR A (C6.45) Port 50 (Cable: PL-FO00039)", "SPINE 2 (C2.43) Port 14 -> TOR B (C6.43) Port 50 (Cable: PL-FO00040)", "FW 2 (C2.42) Port 16 -> TOR BL 2 (C2.39) Port 47 (Cable: PL-FO00041)", "FW 2 (C2.42) Port 17 -> TOR BL 2 (C2.39) Port 48 (Cable: PL-FO00042)", "AGG 2 (C2.41) Port 1 -> BOR B (C1.2) Port 49 (Cable: PL-FO00043)", "AGG 2 (C2.41) Port 2 -> BOR A (C2.4) Port 49 (Cable: PL-FO00044)", "AGG 2 (C2.41) Port 3 -> BOR B (C3.2) Port 49 (Cable: PL-FO00045)", "AGG 2 (C2.41) Port 4 -> BOR A (C4.4) Port 49 (Cable: PL-FO00046)", "AGG 2 (C2.41) Port 5 -> BOR B (C5.2) Port 49 (Cable: PL-FO00047)", "AGG 2 (C2.41) Port 6 -> BOR A (C6.4) Port 49 (Cable: PL-FO00048)", "TOR BL 2 (C2.39) Port 51 -> NatCo NNI link (Cable: PL-FO00050)"],
                "UTP OAM Connections": ["Spine (C2.43) MGMT -> BOR SW A, Port 46", "FW (C2.42) MGMT -> BOR SW A, Port 44", "AGG SW (C2.41) MGMT -> BOR SW A, Port 43", "TOR_SW_BL (C2.39) MGMT -> BOR SW A, Port 42", "TOR_SW_A (C2.37) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C2.35) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C2.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C2.2) MGMT -> BOR SW A, Port 45", "PDU A (C2.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C2.PDU B) MGMT -> BOR SW B, Port 48", "C2.20 Server ILO -> BOR SW A, Port 32", "C2.18 Server ILO -> BOR SW A, Port 31", "C2.16 Server ILO -> BOR SW A, Port 30", "C2.14 Server ILO -> BOR SW A, Port 29", "C2.12 Server ILO -> BOR SW A, Port 28", "C2.10 Server ILO -> BOR SW A, Port 27", "C2.8 Server ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "C2.6 Server ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "UTP Console Connections": ["Console Server (C2.3) Eth1 -> BOR A (C2.2), Port 41", "Console Server (C2.3) Port 1 -> SPINE (C2.43), CON", "Console Server (C2.3) Port 2 -> FW (C2.42), CON", "Console Server (C2.3) Port 3 -> AGG (C2.41), CON", "Console Server (C2.3) Port 4 -> TOR BL (C2.39), CON"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "Spine (C2.43) (N9K-C9336C-FX2): RU 43, PDU A 18, PDU B 18", "FW (C2.42) (SRX1500-AC): RU 42, PDU A 8, PDU B 8", "AGG SW (C2.41) (N9K-C93180YC-FX3H): RU 41, PDU A 27, PDU B 27", "TOR_SW_BL (C2.39) (N9K-C93180YC-FX3H): RU 39, PDU A 17, PDU B 17", "TOR_SW_A (C2.37) (N9K-C93180YC-FX3H): RU 37, PDU A 7, PDU B 7", "TOR_SW_B (C2.35) (N9K-C93180YC-FX3H): RU 35, PDU A 26, PDU B 26", "BOR_SW_A (C2.4) (N9K-C92348GC-X): RU 4, PDU A 21, PDU B 21", "BOR_SW_B (C2.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C2.20) (Lenovo SR650 v3): RU 21, PDU A 14, PDU B 14", "Server (C2.18) (Lenovo SR650 v3): RU 19, PDU A 4, PDU B 4", "Server (C2.16) (Lenovo SR650 v3): RU 17, PDU A 23, PDU B 23", "Server (C2.14) (Lenovo SR650 v3): RU 15, PDU A 13, PDU B 13", "Server (C2.12) (Lenovo SR650 v3): RU 13, PDU A 3, PDU B 3", "Server (C2.10) (Lenovo SR650 v3): RU 11, PDU A 22, PDU B 22", "Server (C2.8) (Lenovo SR650 v3): RU 9, PDU A 12, PDU B 12", "Server (C2.6) (Lenovo SR650 v3): RU 7, PDU A 2, PDU B 2"]
            },
            "C3 (MCS)": {
                "SFP Installation Verification": ["TOR (C3.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C3.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C3.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C3.43)", "TOR (C3.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C3.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C3.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C3.45)", "BOR (C3.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C3.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C3.2)", "BOR (C3.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C3.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C3.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C3.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C3.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C3.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C3.2) MGMT -> BOR SW A, Port 45", "PDU A (C3.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C3.PDU B) MGMT -> BOR SW B, Port 48", "C3.20 Server ILO -> BOR SW A, Port 32", "C3.18 Server ILO -> BOR SW A, Port 31", "C3.16 Server ILO -> BOR SW A, Port 30", "C3.14 Server ILO -> BOR SW A, Port 29", "C3.12 Server ILO -> BOR SW A, Port 28", "C3.10 Server ILO -> BOR SW A, Port 27", "C3.8 Server ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "C3.6 Server ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "TOR_SW_A (C3.45) (N9K-C93180YC-FX3H): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C3.43) (N9K-C93180YC-FX3H): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C3.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C3.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C3.20) (Lenovo SR650 v3): RU 21, PDU A 4, PDU B 4", "Server (C3.18) (Lenovo SR650 v3): RU 19, PDU A 23, PDU B 23", "Server (C3.16) (Lenovo SR650 v3): RU 17, PDU A 13, PDU B 13", "Server (C3.14) (Lenovo SR650 v3): RU 15, PDU A 3, PDU B 3", "Server (C3.12) (Lenovo SR650 v3): RU 13, PDU A 22, PDU B 22", "Server (C3.10) (Lenovo SR650 v3): RU 11, PDU A 12, PDU B 12", "Server (C3.8) (Lenovo SR650 v3): RU 9, PDU A 2, PDU B 2", "Server (C3.6) (Lenovo SR650 v3): RU 7, PDU A 21, PDU B 21"]
            },
            "C4 (CS)": {
                "SFP Installation Verification": ["TOR (C4.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C4.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C4.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C4.43)", "TOR (C4.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C4.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C4.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C4.45)", "BOR (C4.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C4.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C4.2)", "BOR (C4.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C4.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C4.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C4.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C4.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C4.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C4.2) MGMT -> BOR SW A, Port 45", "PDU A (C4.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C4.PDU B) MGMT -> BOR SW B, Port 48", "C4.22 Server IMM -> BOR SW B, Port 25", "C4.20 Server IMM -> BOR SW A, Port 32", "C4.18 Server IMM -> BOR SW A, Port 31", "C4.16 Server IMM -> BOR SW A, Port 30", "C4.14 Server IMM -> BOR SW A, Port 29", "C4.12 Server IMM -> BOR SW A, Port 28", "C4.10 Server IMM -> BOR SW A, Port 27", "C4.8 Server IMM -> BOR SW A, Port 26", "C4.6 Server IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "TOR_SW_A (C4.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C4.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C4.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C4.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C4.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C4.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C4.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C4.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C4.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C4.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C4.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C4.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C4.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12"]
            },
            "C5 (CS)": {
                "SFP Installation Verification": ["TOR (C5.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C5.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C5.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C5.43)", "TOR (C5.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C5.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C5.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C5.45)", "BOR (C5.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C5.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C5.2)", "BOR (C5.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C5.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C5.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C5.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C5.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C5.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C5.2) MGMT -> BOR SW A, Port 45", "PDU A (C5.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C5.PDU B) MGMT -> BOR SW B, Port 48", "C5.22 Server IMM -> BOR SW B, Port 25", "C5.20 Server IMM -> BOR SW A, Port 32", "C5.18 Server IMM -> BOR SW A, Port 31", "C5.16 Server IMM -> BOR SW A, Port 30", "C5.14 Server IMM -> BOR SW A, Port 29", "C5.12 Server IMM -> BOR SW A, Port 28", "C5.10 Server IMM -> BOR SW A, Port 27", "C5.8 Server IMM -> BOR SW A, Port 26", "C5.6 Server IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "TOR_SW_A (C5.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C5.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C5.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C5.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C5.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C5.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C5.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C5.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C5.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C5.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C5.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C5.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C5.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12"]
            },
            "C6 (CS)": {
                "SFP Installation Verification": ["TOR (C6.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C6.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C6.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C6.43)", "TOR (C6.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C6.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C6.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C6.45)", "BOR (C6.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C6.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C6.2)", "BOR (C6.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C6.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C6.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C6.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C6.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C6.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C6.2) MGMT -> BOR SW A, Port 45", "PDU A (C6.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C6.PDU B) MGMT -> BOR SW B, Port 48", "C6.22 Server IMM -> BOR SW B, Port 25", "C6.20 Server IMM -> BOR SW A, Port 32", "C6.18 Server IMM -> BOR SW A, Port 31", "C6.16 Server IMM -> BOR SW A, Port 30", "C6.14 Server IMM -> BOR SW A, Port 29", "C6.12 Server IMM -> BOR SW A, Port 28", "C6.10 Server IMM -> BOR SW A, Port 27", "C6.8 Server IMM -> BOR SW A, Port 26", "C6.6 Server IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF: RU 47", "TOR_SW_A (C6.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C6.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C6.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C6.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C6.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C6.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C6.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C6.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C6.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C6.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C6.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C6.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C6.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12"]
            }
        };
        // #endregion

        // #region STATE & CONFIG
        let state = {};
        const config = {
            racks: {},
            categories: [],
            version: '6.0',
            allItems: {}
        };
        const localStorageKey = 'dcChecklistState_v5';
        // #endregion

        // #region CORE LOGIC & INITIALIZATION
        function init() {
            parseData();
            loadState();
            setupEventListeners();
            setupOfflineHandling();
            updateButtonIcons();

            if (!state.activeCategory && config.categories.length > 0) {
                state.activeCategory = null;
            }
            if (Object.keys(state.selectedRacks).length === 0) {
                Object.keys(config.racks).forEach(rackId => {
                    state.selectedRacks[rackId] = true;
                });
            }

            renderFullUI();
            renderMobile();
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(localStorageKey);
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    if (parsed && typeof parsed.itemStatus === 'object') {
                        state = parsed;
                        return;
                    }
                }
            } catch (e) {
                console.error("Failed to load state, backing up corrupted data.", e);
                const corruptedData = localStorage.getItem(localStorageKey);
                if (corruptedData) {
                    localStorage.setItem(`dcChecklistState_corrupted_${Date.now()}`, corruptedData);
                }
            }
            state = {
                itemStatus: {}, itemNotes: {}, itemTimestamps: {}, rackPhotos: {}, itemData: {}, deviceData: {},
                activeCategory: null, selectedRacks: {}, mobileView: 'main', mobileRack: null, searchTerm: '',
                technicianId: 'Anonymous', isOnline: navigator.onLine
            };
        }

        const saveState = debounce(() => {
            try {
                state.lastSaved = new Date().toISOString();
                state.version = config.version;
                localStorage.setItem(localStorageKey, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
                offerRecoveryOptions(e);
            }
        }, 500);
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function parseData() {
            const uniqueCategories = new Set();
            Object.keys(fullRawData).forEach(rackName => {
                config.racks[rackName] = { name: rackName, items: [] };
                const rackData = fullRawData[rackName];
                Object.keys(rackData).forEach(categoryName => {
                    uniqueCategories.add(categoryName);
                    rackData[categoryName].forEach((itemString, index) => {
                        const [title, ...detailsParts] = itemString.split(' -> ');
                        const details = detailsParts.length > 0 ? `→ ${detailsParts.join(' -> ')}` : '';
                        const itemId = `${sanitizeForId(rackName)}-${sanitizeForId(categoryName)}-${index}`;
                        const item = { id: itemId, title, details, category: categoryName, rack: rackName, notes: '' };
                        config.racks[rackName].items.push(item);
                        config.allItems[itemId] = item;
                    });
                });
            });
            config.categories = Array.from(uniqueCategories).sort();
        }
        // #endregion

        // #region DATA & PHOTO MODALS
        function openItemDataModal(itemId) {
            const item = config.allItems[itemId];
            if (!item) return;

            let bodyHtml;
            let footerButtons;

            const itemType = getItemType(item);
            if (itemType === 'foCable' || itemType === 'utpCable') {
                const currentData = (state.itemData && state.itemData[itemId]) || {};
                bodyHtml = `
                    <div class="form-group">
                        <label for="data-cable-id">Cable ID</label>
                        <input type="text" id="data-cable-id" value="${escapeHTML(currentData.cableId || '')}">
                    </div>
                `;
                footerButtons = [{
                    label: 'Save',
                    className: 'btn',
                    onClick: () => {
                        const input = document.getElementById('data-cable-id');
                        if (!state.itemData) state.itemData = {};
                        if (!state.itemData[itemId]) state.itemData[itemId] = {};
                        state.itemData[itemId].cableId = input.value;
                        saveState();
                        updateUI({ item: itemId });
                        modal.hide();
                    }
                }];
            } else {
                bodyHtml = '<p>No specific data points to register for this item type. Use the "Devices" button on the rack header for device data.</p>';
                footerButtons = [];
            }
            
            modal.show({
                title: `Data for: ${item.title}`,
                body: bodyHtml,
                footerButtons
            });
        }

        function openDeviceDataModal(rackId) {
            const uniqueDevices = definitiveDeviceList[rackId] || [];
            let formHtml = '';

            const saveHandler = () => {
                const inputs = document.getElementById('device-data-body').querySelectorAll('input');
                if (!state.deviceData) state.deviceData = {};
                if (!state.deviceData[rackId]) state.deviceData[rackId] = {};
                
                inputs.forEach(input => {
                    const { deviceName, field } = input.dataset;
                    if (!state.deviceData[rackId][deviceName]) {
                        state.deviceData[rackId][deviceName] = {};
                    }
                    state.deviceData[rackId][deviceName][field] = input.value;
                });
                
                saveState();
                modal.hide();
                showNotification('Device data saved.', 'success');
            };

            if (uniqueDevices.length > 0) {
                uniqueDevices.forEach(deviceName => {
                    const currentSerial = (state.deviceData?.[rackId]?.[deviceName]?.serial) || '';
                    const currentMac = (state.deviceData?.[rackId]?.[deviceName]?.mac) || '';
                    const currentIlo = (state.deviceData?.[rackId]?.[deviceName]?.iloPassword) || '';
                    const deviceId = sanitizeForId(deviceName);
                    
                    formHtml += `<div class="device-data-group"><h3>${escapeHTML(deviceName)}</h3>`;
                    
                    if (getDeviceName(deviceName).toLowerCase() === 'server') {
                        formHtml += `
                            <div class="form-group"><label for="device-serial-${deviceId}">Serial Number</label><input type="text" id="device-serial-${deviceId}" data-device-name="${escapeHTML(deviceName)}" data-field="serial" value="${escapeHTML(currentSerial)}"></div>
                            <div class="form-group"><label for="device-ilo-${deviceId}">ILO Password</label><input type="text" id="device-ilo-${deviceId}" data-device-name="${escapeHTML(deviceName)}" data-field="iloPassword" value="${escapeHTML(currentIlo)}"></div>`;
                    } else {
                        formHtml += `
                             <div class="form-group"><label for="device-serial-${deviceId}">Serial Number</label><input type="text" id="device-serial-${deviceId}" data-device-name="${escapeHTML(deviceName)}" data-field="serial" value="${escapeHTML(currentSerial)}"></div>
                             <div class="form-group"><label for="device-mac-${deviceId}">MAC Address</label><input type="text" id="device-mac-${deviceId}" data-device-name="${escapeHTML(deviceName)}" data-field="mac" value="${escapeHTML(currentMac)}"></div>`;
                    }
                    formHtml += `</div>`;
                });
            } else {
                formHtml = '<p>No devices found in this rack to register.</p>';
            }

            modal.show({
                title: `Device Data for ${rackId}`,
                body: `<div id="device-data-body">${formHtml}</div>`,
                footerButtons: uniqueDevices.length > 0 ? [{ label: 'Save', className: 'btn', onClick: saveHandler }] : []
            });
        }

        function handleRackPhoto(rackId) {
            const existingPhoto = state.rackPhotos[rackId];
            if (existingPhoto) {
                viewRackPhoto(rackId);
            } else {
                captureRackPhoto(rackId);
            }
        }

        function captureRackPhoto(rackId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.rackPhotos[rackId] = {
                            data: e.target.result,
                            timestamp: new Date().toISOString()
                        };
                        saveState();
                        updateUI({ rackPhoto: rackId });
                        showNotification(`Photo added for rack ${rackId}`, "success");
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function viewRackPhoto(rackId) {
            const photo = state.rackPhotos[rackId];
            if (!photo) return;
            
            modal.show({
                title: `Photo for ${rackId}`,
                body: `<img src="${photo.data}" style="width: 100%; height: auto; max-height: 70vh; object-fit: contain;" alt="Photo for rack ${rackId}">`,
                footerButtons: [{
                    label: 'Delete',
                    className: 'btn btn-secondary',
                    onClick: () => {
                        modal.hide();
                        deleteRackPhoto(rackId);
                    }
                }]
            });
        }
        
        function deleteRackPhoto(rackId) {
            modal.show({
                title: `Delete Photo for ${rackId}?`,
                body: `<p>Are you sure you want to delete the photo for rack ${rackId}?</p>`,
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    { 
                        label: 'Delete',
                        className: 'btn',
                        onClick: () => {
                            delete state.rackPhotos[rackId];
                            saveState();
                            updateUI({ rackPhoto: rackId });
                            showNotification(`Photo for rack ${rackId} deleted.`, 'success');
                            modal.hide();
                        }
                    }
                ]
            });
        }
        // #endregion

        // #region UTILITIES
        function triggerVibration() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }
        
        function getDeviceName(deviceString) {
            return deviceString.split(" ")[0];
        }

        function getCategoryProgress(categoryName = null) {
            let verified = 0, failed = 0, needsReview = 0, total = 0;
            const allItems = Object.values(config.allItems).filter(item => state.selectedRacks[item.rack]);
            const items = categoryName ? allItems.filter(i => i.category === categoryName) : allItems;
            total = items.length;
            items.forEach(item => {
                const status = state.itemStatus[item.id];
                if (status === 'verified') verified++;
                else if (status === 'failed') failed++;
                else if (status === 'needs-review') needsReview++;
            });
            return { verified, failed, needsReview, checked: verified + failed + needsReview, total };
        }

        function getRackProgressForCategory(rackId, categoryName, detailed = false) {
            const rack = config.racks[rackId];
            if (!rack) return { verified: 0, failed: 0, needsReview: 0, checked: 0, total: 0 };
            let verified = 0, failed = 0, needsReview = 0, total = 0;
            rack.items.forEach(item => {
                if (item.category === categoryName) {
                    total++;
                    const status = state.itemStatus[item.id];
                    if (status === 'verified') verified++;
                    else if (detailed) {
                        if (status === 'failed') failed++;
                        else if (status === 'needs-review') needsReview++;
                    }
                }
            });
            const checked = verified + failed + needsReview;
            return { verified, failed, needsReview, checked, total };
        }

        function getCategoryStatus(progress) {
            const { total, verified, failed, needsReview, checked } = progress;
            if (total === 0) return 'pending';
            if (verified === total) return 'verified';
            if (failed > 0) return 'failed';
            if (needsReview > 0) return 'needs-review';
            if (checked > 0) return 'in-progress';
            return 'pending';
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'verified': return '✓'; case 'failed': return '✗'; case 'needs-review': return '!';
                case 'in-progress': return '◐'; default: return '';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        function setupOfflineHandling() {
            updateOnlineStatus();
        }

        function updateOnlineStatus() {
            document.getElementById('offline-indicator').classList.toggle('show', !state.isOnline);
        }

        function sanitizeForId(text) {
            return text.replace(/[^a-zA-Z0-9]/g, "_");
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
        }

        function highlight(text, searchTerm) {
            if (!searchTerm) return escapeHTML(text);
            const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            return escapeHTML(text).replace(regex, `<mark>$1</mark>`);
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename; a.style.display = 'none';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function offerRecoveryOptions(error) {
            modal.show({
                title: "Save Failed",
                body: `<p>Unable to save your progress, possibly because your browser's storage is full.</p>
                       <p><strong>Action Recommended:</strong> Export your current progress to a file to avoid losing any work.</p>`,
                footerButtons: [
                    { label: "Export YAML Backup", className: 'btn', onClick: exportYAML },
                    { label: "Continue Anyway", className: 'btn-secondary', onClick: () => modal.hide() }
                ]
            });
        }

        function updateButtonIcons() {
            const buttonMap = {
                '#show-instructions-btn': icons.instructions, '#mobile-show-instructions-btn': icons.instructions,
                '#export-yaml-btn': icons.yaml, '#mobile-export-yaml-btn': icons.yaml,
                '#export-csv-btn': icons.csv, '#mobile-export-csv-btn': icons.csv,
                '#import-btn': icons.import,
                '#backup-btn': icons.backup, '#mobile-backup-btn': icons.backup,
                '#reset-all-btn': icons.reset, '#mobile-reset-all-btn': icons.reset,
                '#mobile-search-btn': icons.search
            };
            for(const [selector, icon] of Object.entries(buttonMap)) {
                const btn = document.querySelector(selector);
                if (btn) btn.innerHTML = icon;
            }
        }
        // #endregion
        
        // #region MODAL SYSTEM
        function showInstructionsModal() {
            const bodyHtml = () => {
                let html = '';
                deploymentInstructionsData.forEach(phase => {
                    html += `<details ${phase.phase.includes('Phase 1') ? 'open' : ''}>
                                <summary>${escapeHTML(phase.phase)}</summary>
                                <ol>${phase.steps.map(step => `
                                    <li>
                                        <strong>${escapeHTML(step.title)}</strong>
                                        ${step.note ? `<span class="note">${escapeHTML(step.note)}</span>` : ''}
                                    </li>`).join('')}
                                </ol>
                             </details>`;
                });
                return html;
            };
            modal.show({
                title: "Data Center Hardware Installation",
                body: bodyHtml(),
                className: 'instructions-modal'
            });
        }
        
        const modal = (function buildModal() {
            const modalEl = document.getElementById('app-modal');
            const dialogEl = modalEl.querySelector('[role="dialog"]');
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            let firstFocusableEl, lastFocusableEl, previouslyFocusedEl;

            function keydownHandler(e) {
                if (e.key === 'Escape') {
                    if (modalEl.dataset.onEscape !== 'ignore') hide();
                }
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstFocusableEl) { lastFocusableEl.focus(); e.preventDefault(); }
                    else if (!e.shiftKey && document.activeElement === lastFocusableEl) { firstFocusableEl.focus(); e.preventDefault(); }
                }
            }

            function clickHandler(e) {
                if (e.target === modalEl && modalEl.dataset.backdrop !== 'static') hide();
            }

            function show({ title, body, footerButtons = [], className, onEscape, backdrop }) {
                modalEl.querySelector('#modal-title').textContent = title;
                modalEl.querySelector('#modal-body').innerHTML = body;
                const footerEl = modalEl.querySelector('#modal-footer');
                footerEl.innerHTML = '';
                footerButtons.forEach(btnConfig => {
                    const btn = document.createElement('button');
                    btn.textContent = btnConfig.label;
                    btn.className = btnConfig.className || 'btn';
                    btn.onclick = btnConfig.onClick;
                    footerEl.appendChild(btn);
                });
                
                dialogEl.className = `modal-content ${className || ''}`;
                modalEl.dataset.onEscape = onEscape || '';
                modalEl.dataset.backdrop = backdrop || '';
                
                modalEl.classList.add('is-visible');
                previouslyFocusedEl = document.activeElement;

                const focusable = modalEl.querySelectorAll(focusableElements);
                firstFocusableEl = focusable[0];
                lastFocusableEl = focusable[focusable.length - 1];

                setTimeout(() => {
                    const elToFocus = footerEl.querySelector('button') || bodyEl.querySelector('input, button, textarea') || firstFocusableEl;
                    if (elToFocus) elToFocus.focus();
                }, 100);

                modalEl.addEventListener('keydown', keydownHandler);
                modalEl.addEventListener('click', clickHandler);
            }

            function hide() {
                modalEl.classList.remove('is-visible');
                if (previouslyFocusedEl) previouslyFocusedEl.focus();
                modalEl.removeEventListener('keydown', keydownHandler);
                modalEl.removeEventListener('click', clickHandler);
            }

            return { show, hide };
        })();
        // #endregion

        // #region UI RENDERING & UPDATES
        function updateUI({ category, rack, item, all = false, stats = false, rackSelection = false, rackPhoto }) {
            if (all || stats || rackSelection) {
                renderFullUI();
                renderMobile();
                return;
            }

            if (rackPhoto) {
                const rackTitle = document.querySelector(`.detail-rack-group-title[data-rack-id="${rackPhoto}"]`);
                if (rackTitle) {
                    const indicator = rackTitle.querySelector('.rack-photo-indicator');
                    const hasPhoto = state.rackPhotos[rackPhoto] ? `<span style="color: var(--success-color);">📸</span>` : '';
                    indicator.innerHTML = hasPhoto;
                }
            }
            if (category) updateCategoryUI(category);
            if (rack) updateRackOverviewUI(rack);
            if (item) updateItemUI(item);
            updateOverallStatsUI();
        }

        function renderFullUI() {
            renderBreadcrumb();
            renderRackSelector();
            renderCategories();
            renderRackOverview();
            renderEquipmentDetail();
            updateOverallStatsUI();
        }

        function renderBreadcrumb() {
            const container = document.getElementById('breadcrumb-container');
            if (!container) return;
            let html = '<ol>';
            html += `<li><a href="#" data-nav="home">📊 DC Deployment Checklist</a></li>`;
            if (state.activeCategory) {
                html += `<li><span class="breadcrumb-separator">/</span><a href="#" data-nav="category">${state.activeCategory}</a></li>`;
            }
            html += '</ol>';
            container.innerHTML = html;
        }
        
        function updateOverallStatsUI() {
            const progress = getCategoryProgress();
            const statsEl = document.getElementById('overall-stats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <span title="Verified"><div class="status-icon verified">✓</div> ${progress.verified}</span>
                    <span title="Failed"><div class="status-icon failed">✗</div> ${progress.failed}</span>
                    <span title="Needs Review"><div class="status-icon needs-review">!</div> ${progress.needsReview}</span>
                    <span title="Total">Σ ${progress.total}</span>
                `;
            }
            const mobileProgressEl = document.getElementById('mobile-total-progress');
            if(mobileProgressEl) {
                const percentage = progress.total > 0 ? Math.round(progress.verified / progress.total * 100) : 0;
                mobileProgressEl.textContent = `📊 ${percentage}%`;
            }
        }

        function renderRackSelector() {
            const containers = document.querySelectorAll(".rack-selector-container");
            const rackIds = Object.keys(config.racks);
            const allSelected = rackIds.length > 0 && rackIds.every(id => state.selectedRacks[id]);
            let html = '<div class="rack-selector-grid">';
            html += `<label><input type="checkbox" value="all" ${allSelected ? "checked" : ""}> <span>All</span></label>`;
            rackIds.forEach(id => {
                html += `<label><input type="checkbox" value="${id}" ${state.selectedRacks[id] ? "checked" : ""}> <span>${id.split(" ")[0]}</span></label>`;
            });
            html += "</div>";
            containers.forEach(c => c.innerHTML = html);
        }

        function renderCategories() {
            const container = document.getElementById("category-list");
            if (!container) return;
            container.innerHTML = config.categories.map(generateCategoryHTML).join('');
        }

        function updateCategoryUI(categoryId) {
            const el = document.querySelector(`.category-list-item[data-category-id="${categoryId}"]`);
            if (el) el.outerHTML = generateCategoryHTML(categoryId);
        }
        
        function generateCategoryHTML(categoryName) {
            const progress = getCategoryProgress(categoryName);
            const status = getCategoryStatus(progress);
            const activeClass = state.activeCategory === categoryName ? "active" : "";
            return `
                <li class="category-list-item ${activeClass}" data-category-id="${categoryName}" tabindex="0" role="button">
                    <span class="status-icon ${status}">${getStatusIcon(status)}</span>
                    ${categoryName} <small>(${progress.checked}/${progress.total})</small>
                </li>`;
        }

        function renderRackOverview() {
            const container = document.getElementById("rack-overview-list");
            if (!container) return;
            if (!state.activeCategory) {
                container.innerHTML = '<div class="no-selection">Select a category to see rack progress.</div>';
                return;
            }
            let html = "";
            Object.keys(config.racks).forEach(rackId => {
                if (state.selectedRacks[rackId]) {
                   html += generateRackOverviewHTML(rackId);
                }
            });
            container.innerHTML = html || '<div class="no-selection">No racks for this category.</div>';
        }

        function updateRackOverviewUI(rackId) {
            const el = document.querySelector(`.rack-list-item[data-rack-id="${rackId}"]`);
            if (el) el.outerHTML = generateRackOverviewHTML(rackId);
        }
        
        function generateRackOverviewHTML(rackId) {
            const progress = getRackProgressForCategory(rackId, state.activeCategory);
            if (progress.total === 0) return '';
            const percentage = progress.total > 0 ? (progress.verified / progress.total) * 100 : 0;
            return `
                <li class="rack-list-item" data-rack-id="${rackId}">
                    <button class="rack-list-item-main" data-rack-id="${rackId}" aria-label="Scroll to ${rackId} details">
                        <div class="rack-name">${rackId.split(" ")[0]}</div>
                        <div class="rack-progress-bar" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                            <div class="rack-progress-fill" style="width:${percentage}%;"></div>
                        </div>
                        <span class="percentage">${Math.round(percentage)}%</span>
                    </button>
                    <button class="rack-overview-devices-btn" data-rack-id="${rackId}" title="Device Data for ${rackId}">${icons.devices}</button>
                </li>`;
        }

        function renderEquipmentDetail() {
            const container = document.getElementById("equipment-detail-content");
            const titleEl = document.getElementById("detail-panel-title");
            if (!container || !titleEl) return;

            if (!state.activeCategory) {
                container.innerHTML = '<div class="no-selection">Select a Category to view details</div>';
                titleEl.textContent = "🔧 Equipment Detail";
                return;
            }

            titleEl.textContent = `🔧 ${state.activeCategory}`;
            let html = "";
            const searchTerm = state.searchTerm.toLowerCase();
            let itemsFound = false;

            Object.keys(config.racks).forEach(rackId => {
                if (!state.selectedRacks[rackId]) return;

                const rack = config.racks[rackId];
                const items = rack.items.filter(item =>
                    item.category === state.activeCategory &&
                    (!searchTerm || (item.title.toLowerCase().includes(searchTerm) || item.details.toLowerCase().includes(searchTerm)))
                );

                if (items.length > 0) {
                    itemsFound = true;
                    const allVerified = items.every(item => state.itemStatus[item.id] === "verified");
                    const hasPhoto = state.rackPhotos[rackId] ? '<span style="color: var(--success-color);">📸</span>' : '';

                    html += `
                        <div class="detail-rack-group">
                            <h3 id="detail-rack-${sanitizeForId(rackId)}">
                                <label class="detail-rack-group-title" data-rack-id="${rackId}">
                                    <input type="checkbox" class="rack-master-check" data-rack-id="${rackId}" ${allVerified ? "checked" : ""}>
                                    <span>${rackId} <span class="rack-photo-indicator">${hasPhoto}</span></span>
                                </label>
                                <div class="rack-controls">
                                    <button class="rack-control-btn" data-rack-id="${rackId}" data-action="devices" title="Enter Device Data">${icons.devices}</button>
                                    <button class="rack-control-btn" data-rack-id="${rackId}" data-action="photo" title="Add/View Rack Photo">${icons.photo}</button>
                                    <button class="rack-control-btn" data-rack-id="${rackId}" data-action="reset" title="Reset Rack Progress">${icons.reset}</button>
                                </div>
                            </h3>
                            <ul class="equipment-list">${items.map(generateItemHTML).join('')}</ul>
                        </div>`;
                }
            });
            container.innerHTML = itemsFound ? html : '<div class="no-selection">No items match your selection or search.</div>';
        }

        function updateItemUI(itemId) {
            const item = config.allItems[itemId];
            const desktopEl = document.getElementById(`item-${itemId}`);
            const mobileEl = document.getElementById(`mobile-item-${itemId}`);
            if (desktopEl) desktopEl.outerHTML = generateItemHTML(item);
            if (mobileEl) mobileEl.outerHTML = generateMobileItemHTML(item);
        }

        function generateItemHTML(item) {
            const status = state.itemStatus[item.id] || "pending";
            const note = state.itemNotes[item.id];
            const timestamp = state.itemTimestamps[item.id];
            const noteHTML = note ? `<div class="item-note">Note: ${escapeHTML(note)}</div>` : "";
            const timestampHTML = timestamp ? `<div style="font-size: 0.8em; color: var(--border-color); margin-top: 0.5rem;">Last updated: ${new Date(timestamp).toLocaleString()}</div>` : "";
            
            const itemType = getItemType(item);
            const hasData = state.itemData && state.itemData[item.id] && Object.values(state.itemData[item.id]).some(d => d);
            const dataBtnHtml = (itemType === 'foCable' || itemType === 'utpCable') ?
                `<button class="item-control-btn" data-item-id="${item.id}" data-action="data" title="${hasData ? 'Edit collected data' : 'Collect data for this item'}">${icons.data}</button>` : '';

            return `
                <li class="equipment-list-item" id="item-${item.id}">
                    <div class="equipment-header">
                        <div class="title">${highlight(item.title, state.searchTerm)}</div>
                        <div class="item-controls">
                            <button class="item-control-btn" data-item-id="${item.id}" data-action="note" title="Add note">${icons.note}</button>
                            ${dataBtnHtml}
                            <select class="status-select" data-item-id="${item.id}" aria-label="Status for ${escapeHTML(item.title)}">
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>⭕ Pending</option>
                                <option value="verified" ${status === 'verified' ? 'selected' : ''}>✅ Verified</option>
                                <option value="failed" ${status === 'failed' ? 'selected' : ''}>❌ Failed</option>
                                <option value="needs-review" ${status === 'needs-review' ? 'selected' : ''}>⚠️ Needs Review</option>
                            </select>
                        </div>
                    </div>
                    <div class="equipment-details">${highlight(item.details, state.searchTerm)}</div>
                    ${noteHTML}${timestampHTML}
                </li>`;
        }
        
        function getItemType(item) {
            const title = item.title.toLowerCase();
            const category = item.category.toLowerCase();
            if (title.includes('server')) return 'server';
            if (title.includes('spine') || title.includes('fw') || title.includes('agg') || title.includes('tor') || title.includes('bor')) return 'networkDevice';
            if (category.includes('fiber optic')) return 'foCable';
            if (category.includes('utp')) return 'utpCable';
            return 'generic';
        }
        // #endregion
        
        // #region MOBILE RENDERING
        function renderMobile() {
            document.getElementById("mobile-panel-main").classList.toggle("active", state.mobileView === "main");
            document.getElementById("mobile-panel-items").classList.toggle("active", state.mobileView === "items");

            if (state.mobileView === 'main') renderMobileMainList();
            else if (state.mobileView === 'items') renderMobileItemList();
        }

        function renderMobileMainList() {
            const container = document.getElementById("mobile-main-list");
            if (!container) return;
            updateOverallStatsUI();

            let html = "";
            config.categories.forEach(categoryName => {
                const racksForCategory = Object.keys(config.racks).filter(rackId => 
                    state.selectedRacks[rackId] && config.racks[rackId].items.some(item => item.category === categoryName)
                );
                if (racksForCategory.length > 0) {
                    html += `<li class="mobile-main-category-header">${categoryName}</li>`;
                    racksForCategory.forEach(rackId => {
                        const progress = getRackProgressForCategory(rackId, categoryName, true);
                        const percentage = progress.total > 0 ? Math.round(progress.verified / progress.total * 100) : 0;
                        html += `
                            <li class="mobile-rack-item" data-rack-id="${rackId}" data-category-id="${categoryName}">
                                <div class="rack-list-item-main" role="button" tabindex="0">
                                    <span class="status-icon ${getCategoryStatus(progress)}">${getStatusIcon(getCategoryStatus(progress))}</span>
                                    <span class="rack-name">${rackId.split(" ")[0]}</span>
                                    <div class="rack-progress-bar"><div class="rack-progress-fill" style="width:${percentage}%;"></div></div>
                                    <span class="percentage">${percentage}%</span>
                                </div>
                                <button class="rack-overview-devices-btn mobile-rack-devices-btn" data-rack-id="${rackId}">${icons.devices}</button>
                            </li>`;
                    });
                }
            });
            container.innerHTML = html;
        }

        function renderMobileItemList() {
            const container = document.getElementById("mobile-item-list");
            if (!container || !state.mobileRack || !state.activeCategory) return;

            document.getElementById("mobile-item-title").textContent = `${state.mobileRack.split(" ")[0]} - ${state.activeCategory}`;
            const rack = config.racks[state.mobileRack];
            const searchTerm = state.searchTerm.toLowerCase();
            const items = rack.items.filter(item => 
                item.category === state.activeCategory &&
                (!searchTerm || (item.title.toLowerCase().includes(searchTerm) || item.details.toLowerCase().includes(searchTerm)))
            );

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color)">
                    <div style="display: flex; justify-content: space-around; align-items: center;">
                        <button class="rack-control-btn" data-rack-id="${state.mobileRack}" data-action="devices">${icons.devices} Devices</button>
                        <button class="rack-control-btn" data-rack-id="${state.mobileRack}" data-action="photo">${icons.photo} Photo</button>
                        <button class="rack-control-btn" data-rack-id="${state.mobileRack}" data-action="reset">${icons.reset} Reset</button>
                    </div>
                </div>`;
            items.forEach(item => { html += generateMobileItemHTML(item); });
            container.innerHTML = html || '<div class="no-selection">No items match your selection or search.</div>';
        }
        
        function generateMobileItemHTML(item) {
            const status = state.itemStatus[item.id] || "pending";
            const note = state.itemNotes[item.id];
            
            const itemType = getItemType(item);
            const hasData = state.itemData && state.itemData[item.id] && Object.values(state.itemData[item.id]).some(d => d);
            const dataBtnHtml = (itemType === 'foCable' || itemType === 'utpCable') ?
                `<button class="item-control-btn" data-item-id="${item.id}" data-action="data" title="${hasData ? 'Edit collected data' : 'Collect data for this item'}">${icons.data}</button>` : '';

            return `
                <div class="mobile-equipment-item" id="mobile-item-${item.id}">
                    <div class="mobile-equipment-header">
                        <div class="mobile-equipment-title">${highlight(item.title, state.searchTerm)}</div>
                        <div class="mobile-equipment-controls">
                             <button class="item-control-btn" data-item-id="${item.id}" data-action="note" title="Add note">${icons.note}</button>
                            ${dataBtnHtml}
                        </div>
                    </div>
                    <div class="equipment-details">${highlight(item.details, state.searchTerm)}</div>
                    ${note ? `<div class="item-note">Note: ${escapeHTML(note)}</div>` : ""}
                    <div style="margin-top: .75rem">
                         <select class="status-select" data-item-id="${item.id}" style="width: 100%; height: 44px;">
                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>⭕ Pending</option>
                            <option value="verified" ${status === 'verified' ? 'selected' : ''}>✅ Verified</option>
                            <option value="failed" ${status === 'failed' ? 'selected' : ''}>❌ Failed</option>
                            <option value="needs-review" ${status === 'needs-review' ? 'selected' : ''}>⚠️ Needs Review</option>
                        </select>
                    </div>
                </div>`;
        }
        // #endregion
        
        // #region EVENT HANDLING & USER ACTIONS
        function setupEventListeners() {
            document.body.addEventListener('click', handleBodyClick);
            document.body.addEventListener('change', handleBodyChange);
            document.body.addEventListener('keydown', handleBodyKeydown);

            const searchInput = document.getElementById("search-input");
            searchInput.addEventListener("input", debounce(e => {
                state.searchTerm = e.target.value;
                renderEquipmentDetail();
            }, 300));
            
            const mobileSearchInput = document.getElementById("mobile-search-input");
            mobileSearchInput.addEventListener("input", debounce(e => {
                state.searchTerm = e.target.value;
                renderMobile();
            }, 300));

            window.addEventListener('online', () => { state.isOnline = true; updateOnlineStatus(); });
            window.addEventListener('offline', () => { state.isOnline = false; updateOnlineStatus(); });
        }

        function handleBodyClick(e) {
            const target = e.target;
            const btn = target.closest('button, .mobile-rack-item');
            if (btn) triggerVibration();

            // --- Modals, Overlays, Global Controls ---
            if (target.closest('#show-instructions-btn, #mobile-show-instructions-btn')) { showInstructionsModal(); return; }
            if (target.id === 'mobile-filter-racks-btn') {
                modal.show({
                    title: 'Filter by Rack',
                    body: '<div id="modal-rack-selector" class="rack-selector-container"></div>',
                    footerButtons: [{ label: 'Done', className: 'btn', onClick: () => modal.hide() }]
                });
                renderRackSelector();
                return;
            }
            if (target.closest('.modal-close-btn')) { modal.hide(); return; }
            if (target.id === 'mobile-search-btn') {
                document.getElementById('search-overlay').classList.add('is-visible');
                document.getElementById('mobile-search-input').focus();
                return;
            }
            if (target.id === 'close-search-overlay-btn') {
                document.getElementById('search-overlay').classList.remove('is-visible');
                return;
            }
            if (target.id === 'export-yaml-btn' || target.id === 'mobile-export-yaml-btn') { exportYAML(e.currentTarget); return; }
            if (target.id === 'export-csv-btn' || target.id === 'mobile-export-csv-btn') { exportCSV(e.currentTarget); return; }
            if (target.id === 'import-btn') { importState(); return; }
            if (target.id === 'backup-btn' || target.id === 'mobile-backup-btn') { createBackup(); return; }
            if (target.id === 'reset-all-btn' || target.id === 'mobile-reset-all-btn') { resetAllProgress(); return; }

            // --- Navigation ---
            const navLink = target.closest('[data-nav]');
            if (navLink) { e.preventDefault(); handleNavigation(navLink.dataset.nav); return; }
            const categoryItem = target.closest(".category-list-item");
            if (categoryItem) { selectCategory(categoryItem.dataset.categoryId); return; }
            const rackItemMain = target.closest(".desktop-view .rack-list-item-main");
            if (rackItemMain) { scrollToRack(rackItemMain.dataset.rackId); return; }

            // --- Mobile Navigation ---
            const mobileRackItem = target.closest(".mobile-rack-item .rack-list-item-main");
            if (mobileRackItem) {
                const parent = mobileRackItem.closest('.mobile-rack-item');
                selectCategoryAndRackForMobile(parent.dataset.categoryId, parent.dataset.rackId);
                return;
            }
            const mobileBackBtn = target.closest(".mobile-back-btn");
            if (mobileBackBtn) { setMobileView('main'); return; }

            // --- Item/Rack Controls ---
            const itemControlBtn = target.closest('.item-control-btn');
            if (itemControlBtn) {
                handleItemAction(itemControlBtn.dataset.itemId, itemControlBtn.dataset.action);
                return;
            }
            const rackControlBtn = target.closest('.rack-control-btn, .rack-overview-devices-btn');
            if(rackControlBtn) {
                const action = rackControlBtn.dataset.action || 'devices'; // default for overview btn
                handleRackAction(rackControlBtn.dataset.rackId, action);
                return;
            }
        }

        function handleBodyChange(e) {
            const target = e.target;
            if (target.closest(".rack-selector-container") && target.type === 'checkbox') {
                updateRackSelection(target.value, target.checked);
            } else if (target.classList.contains('rack-master-check')) {
                toggleAllItemsInRack(target.dataset.rackId, target.checked);
            } else if (target.classList.contains('status-select')) {
                setItemStatus(target.dataset.itemId, target.value);
            }
        }

        function handleBodyKeydown(e) {
             if (e.key === 'Escape' && document.querySelector('.modal-overlay.is-visible')) modal.hide();
             if ((e.key === 'Enter' || e.key === ' ') && e.target.closest('[role="button"]')) { e.preventDefault(); e.target.click(); }
             if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') { e.preventDefault(); createBackup(); }
                else if (e.key === 'e') { e.preventDefault(); exportYAML(); }
                else if (e.key === 'f') { e.preventDefault(); document.getElementById("search-input").focus(); }
            }
        }

        function handleNavigation(navTarget) {
            if (navTarget === 'home') {
                state.activeCategory = null;
                updateUI({ all: true });
            } else if (navTarget === 'category') {
                selectCategory(state.activeCategory);
            }
        }

        function handleItemAction(itemId, action) {
            if (action === 'note') promptForNote(itemId);
            else if (action === 'data') openItemDataModal(itemId);
        }

        function handleRackAction(rackId, action) {
            if (action === 'devices') openDeviceDataModal(rackId);
            else if (action === 'photo') handleRackPhoto(rackId);
            else if (action === 'reset') resetRackProgress(rackId);
        }
        
        function selectCategory(categoryId) {
            state.activeCategory = categoryId;
            saveState();
            updateUI({ all: true });
        }
        
        function selectCategoryAndRackForMobile(categoryId, rackId) {
            state.activeCategory = categoryId;
            state.mobileRack = rackId;
            setMobileView("items");
        }

        function setMobileView(view) {
            state.mobileView = view;
            saveState();
            renderMobile();
        }

        function setItemStatus(itemId, newStatus) {
            if (newStatus === "pending") {
                delete state.itemStatus[itemId];
                delete state.itemTimestamps[itemId];
            } else {
                state.itemStatus[itemId] = newStatus;
                state.itemTimestamps[itemId] = new Date().toISOString();
            }
            saveState();
            const item = config.allItems[itemId];
            updateUI({ item: itemId, category: item.category, rack: item.rack });
        }

        function toggleAllItemsInRack(rackId, isChecked) {
            const items = config.racks[rackId].items.filter(item => item.category === state.activeCategory);
            items.forEach(item => {
                const newStatus = isChecked ? "verified" : "pending";
                setItemStatus(item.id, newStatus);
            });
            renderEquipmentDetail(); // Re-render the whole detail pane for visual sync
        }

        function updateRackSelection(rackId, isChecked) {
            if (rackId === "all") {
                Object.keys(config.racks).forEach(id => state.selectedRacks[id] = isChecked);
            } else {
                state.selectedRacks[rackId] = isChecked;
            }
            saveState();
            updateUI({ all: true });
        }

        function scrollToRack(rackId) {
            const element = document.getElementById(`detail-rack-${sanitizeForId(rackId)}`);
            if (element) {
                element.scrollIntoView({ behavior: "smooth", block: "start" });
                element.focus();
            }
        }
        
        function promptForNote(itemId) {
            const item = config.allItems[itemId];
            const currentNote = state.itemNotes[itemId] || "";
            modal.show({
                title: 'Edit Note',
                body: `<div class="form-group"><label for="item-note-input">Note for: ${escapeHTML(item.title)}</label><textarea id="item-note-input">${escapeHTML(currentNote)}</textarea></div>`,
                footerButtons: [{ label: 'Save', className: 'btn',
                    onClick: () => {
                        const newNote = document.getElementById('item-note-input').value.trim();
                        if (newNote) { state.itemNotes[itemId] = newNote; } 
                        else { delete state.itemNotes[itemId]; }
                        saveState(); updateUI({ item: itemId }); modal.hide();
                    }
                }]
            });
        }
        
        function resetRackProgress(rackId) {
            modal.show({
                title: `Reset progress for ${rackId}?`,
                body: `<p>Are you sure you want to reset all progress, notes, and data for rack <strong>${rackId}</strong>? This cannot be undone.</p>`,
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    { label: 'Reset', className: 'btn',
                        onClick: () => {
                            config.racks[rackId].items.forEach(item => {
                                delete state.itemStatus[item.id]; delete state.itemNotes[item.id];
                                delete state.itemTimestamps[item.id];
                                if (state.itemData) delete state.itemData[item.id];
                            });
                            saveState();
                            showNotification(`Progress reset for rack ${rackId}`, "success");
                            modal.hide();
                            if (state.mobileView === 'items') { setMobileView('main'); renderFullUI(); }
                            else { updateUI({ all: true }); }
                        }
                    }
                ]
            });
        }

        function resetAllProgress() {
            modal.show({
                title: "Reset All Progress?",
                body: '<p>Are you sure? This will clear all statuses, notes, photos, and collected data. This action cannot be undone.</p>',
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    { label: 'Reset Everything', className: 'btn',
                        onClick: () => {
                            state.itemStatus = {}; state.itemNotes = {}; state.itemTimestamps = {};
                            state.itemData = {}; state.deviceData = {}; state.rackPhotos = {};
                            saveState(); updateUI({ all: true });
                            showNotification("All progress has been reset", "success");
                            modal.hide();
                        }
                    }
                ]
            });
        }
        // #endregion

        // #region DATA I/O
        function exportYAML(buttonEl) {
            if (buttonEl) {
                buttonEl.classList.add('loading');
                buttonEl.disabled = true;
            }
            setTimeout(() => {
                try {
                    const exportData = {
                        metadata: { timestamp: new Date().toISOString(), version: config.version, technician: state.technicianId },
                        state: state,
                    };
                    const blob = new Blob([jsyaml.dump(exportData)], { type: "text/yaml" });
                    downloadBlob(blob, `dc_checklist_${new Date().toISOString().split('T')[0]}.yaml`);
                    showNotification("Exported to YAML", "success");
                } catch (e) {
                    console.error("YAML Export failed", e);
                    showNotification("YAML Export failed", "error");
                } finally {
                    if (buttonEl) { buttonEl.classList.remove('loading'); buttonEl.disabled = false; }
                }
            }, 50);
        }

        function exportCSV(buttonEl) {
            if (buttonEl) {
                buttonEl.classList.add('loading');
                buttonEl.disabled = true;
            }
            setTimeout(() => {
                try {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "ID,Rack,Category,ItemTitle,Status,Notes,SerialNumber,MACAddress,ILOPassword,CableID\r\n";
                    Object.values(config.allItems).forEach(item => {
                        const status = state.itemStatus[item.id] || "pending";
                        const notes = state.itemNotes[item.id] || "";
                        let data = (state.itemData && state.itemData[item.id]) || {};
                        let deviceData = {};
                        if (item.category === 'Rack Layout, Positioning, and Power') {
                            const deviceNameMatch = item.title.match(/^(.*?)\s\(/);
                            if (deviceNameMatch) {
                                const deviceKey = deviceNameMatch[1].trim();
                                deviceData = (state.deviceData?.[item.rack]?.[deviceKey]) || {};
                            }
                        }
                        const row = [item.id, item.rack, item.category, `"${item.title.replace(/"/g, '""')}"`, status,
                            `"${notes.replace(/"/g, '""')}"`, deviceData.serial || "", deviceData.mac || "",
                            deviceData.iloPassword || "", data.cableId || ""
                        ].join(",");
                        csvContent += row + "\r\n";
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `dc_checklist_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification("Exported to CSV", "success");
                } catch (e) {
                    console.error("CSV Export failed", e);
                    showNotification("CSV Export failed", "error");
                } finally {
                    if (buttonEl) { buttonEl.classList.remove('loading'); buttonEl.disabled = false; }
                }
            }, 50);
        }

        function importState() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.yaml,.yml';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importData = file.name.endsWith('.json') ? JSON.parse(e.target.result) : jsyaml.load(e.target.result);
                        if (importData.state && typeof importData.state.itemStatus === 'object') {
                            state = { ...state, ...importData.state };
                            saveState(); updateUI({ all: true });
                            showNotification("Progress imported successfully", "success");
                        } else { throw new Error("Invalid file format"); }
                    } catch (error) {
                        console.error("Import failed:", error);
                        showNotification("Import failed: Invalid file", "error");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function createBackup() {
            const backupData = { timestamp: new Date().toISOString(), state: state };
            localStorage.setItem(`dcChecklistBackup_${Date.now()}`, JSON.stringify(backupData));
            showNotification("Backup created in local storage", "success");
            const keys = Object.keys(localStorage).filter(key => key.startsWith('dcChecklistBackup_'));
            keys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
        }
        // #endregion

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
