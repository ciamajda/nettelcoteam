<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Deployment Checklist v6.0 (UX Optimized)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        /**
         * DC Deployment Checklist v6.0 CSS (UX Optimized)
         * Implements UX Audit recommendations: cleaner visuals, contextual actions.
         */
        :root {
            --bg-color: #1a1d24;
            --panel-bg: #21252e;
            --panel-bg-lighter: #282c37;
            --text-color: #c0c5ce;
            --text-light: #e0e7ff;
            --border-color: #4a5568;
            --border-color-subtle: #3a4150;
            --accent-color: #63b3ed;
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #f6e05e;
            --needs-review-color: #ed8936;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: var(--font-mono);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            line-height: 1.6;
            font-size: 14px;
        }

        .desktop-view {
            display: grid;
            grid-template-columns: 250px 1fr 2fr;
            grid-template-rows: auto auto 1fr;
            grid-template-areas:
                "header header header"
                "controls controls controls"
                "sidebar overview detail";
            gap: 1rem;
            height: calc(100vh - 2rem);
            max-width: 1800px;
            margin: 0 auto;
        }

        .desktop-view.rack-view {
            grid-template-areas:
                "header header header"
                "controls controls controls"
                "sidebar detail detail";
        }

        .app-header {
            grid-area: header;
            padding: .5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color-subtle);
        }

        .header-title {
            font-size: 1.2em;
            margin: 0;
        }

        .app-controls {
            grid-area: controls;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .panel {
            border: none;
            background-color: var(--panel-bg);
            padding: 1rem;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .desktop-view.rack-view .panel-overview {
            display: none;
        }

        .panel-sidebar { grid-area: sidebar; }
        .panel-overview { grid-area: overview; }
        .panel-detail { grid-area: detail; }

        .panel-title {
            font-weight: 700;
            color: var(--text-light);
            font-size: 1.1em;
            margin: 0 0 1rem;
            padding-bottom: .5rem;
            border-bottom: 1px solid var(--border-color-subtle);
            display: flex;
            align-items: center;
            gap: .5rem;
            flex-shrink: 0;
        }

        .panel-content {
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .sidebar-list { list-style: none; padding: 0; margin: 0; }
        .sidebar-list-item {
            padding: .5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: .75rem;
            transition: background-color .2s;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }
        .sidebar-list-item:hover { background-color: rgba(255, 255, 255, .05); }
        .sidebar-list-item.active {
            color: var(--accent-color);
            font-weight: 700;
            background-color: rgba(99, 179, 237, .1);
        }

        .rack-list-item { display: flex; align-items: center; gap: .5rem; }
        .rack-list-item-main {
            flex-grow: 1;
            border: none;
            background: none;
            font-family: var(--font-mono);
            color: var(--text-color);
            font-size: 1em;
            padding: .5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: .75rem;
            transition: background-color .2s;
            border-radius: 4px;
        }
        .rack-list-item-main:hover { background-color: rgba(255, 255, 255, .05); }

        .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 12px;
            font-weight: 700;
        }
        .status-icon.verified { background-color: var(--success-color); color: #fff; }
        .status-icon.failed { background-color: var(--error-color); color: #fff; }
        .status-icon.needs-review { background-color: var(--needs-review-color); color: #fff; }
        .status-icon.in-progress { background-color: var(--accent-color); color: #fff; }
        .status-icon.pending { border: 1px solid var(--border-color); background: none; }
        
        .rack-progress-bar {
            width: 100%;
            height: 16px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }
        .rack-progress-fill { height: 100%; background-color: var(--accent-color); transition: width .3s; }
        
        .rack-list-item .rack-name { width: 100px; flex-shrink: 0; }
        .rack-list-item .percentage { width: 50px; text-align: right; }
        
        .equipment-list { list-style: none; padding: 0; margin: 0; }
        .equipment-list-item {
            border: 1px solid var(--border-color-subtle);
            padding: 1rem;
            margin-bottom: .75rem;
            background-color: var(--panel-bg-lighter);
            border-radius: 4px;
        }

        .equipment-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .equipment-header .title { font-weight: 700; color: var(--text-light); flex-grow: 1; }
        .equipment-details { margin-top: .5rem; padding-left: 1rem; color: var(--text-color); font-size: .9em; word-break: break-all; }
        .item-note {
            font-style: italic;
            color: var(--warning-color);
            margin-top: .5rem;
            padding: .5rem;
            background-color: rgba(246, 224, 94, .1);
            border-radius: 4px;
            border-left: 3px solid var(--warning-color);
        }

        .item-controls { display: flex; gap: .5rem; align-items: center; }
        .note-btn, .photo-btn, .data-btn {
            cursor: pointer;
            padding: .25rem .5rem;
            border-radius: 3px;
            transition: background-color .2s;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 0.8em;
            font-family: var(--font-mono);
        }
        .note-btn:hover, .photo-btn:hover, .data-btn:hover { background-color: rgba(255, 255, 255, .1); }
        .data-btn.has-data { border-color: var(--success-color); color: var(--success-color); }
        
        .status-toggle {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 4px;
            transition: all .2s;
        }
        .status-toggle.verified { border-color: var(--success-color); background-color: var(--success-color); color: #fff; }
        .status-toggle.failed { border-color: var(--error-color); background-color: var(--error-color); color: #fff; }
        .status-toggle.needs-review { border-color: var(--needs-review-color); background-color: var(--needs-review-color); color: #fff; }

        .search-input {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: .5rem;
            width: 200px;
            border-radius: 4px;
        }

        .search-input:focus,
        .btn:focus-visible,
        .note-btn:focus-visible,
        .photo-btn:focus-visible,
        .data-btn:focus-visible,
        .status-toggle:focus-visible,
        .rack-selector-container input:focus-visible+span {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .btn {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: .5rem 1rem;
            cursor: pointer;
            font-family: var(--font-mono);
            border-radius: 4px;
            transition: background-color .2s;
            font-weight: 700;
        }
        .btn:hover { background-color: #5299d3; }

        .btn-secondary { background-color: var(--border-color); color: var(--text-light); }
        .btn-secondary:hover { background-color: #5a6c7d; }
        
        .view-toggle { display: flex; border: 1px solid var(--border-color); border-radius: 4px; }
        .view-toggle .btn { border-radius: 0; background: none; color: var(--text-color); }
        .view-toggle .btn.active { background: var(--accent-color); color: var(--bg-color); }
        .view-toggle .btn:first-child { border-top-left-radius: 3px; border-bottom-left-radius: 3px; }
        .view-toggle .btn:last-child { border-top-right-radius: 3px; border-bottom-right-radius: 3px; }

        .rack-selector-container {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color-subtle);
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        .rack-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: .5rem; }
        .rack-selector-grid label { display: inline-flex; align-items: center; padding: .25rem .5rem; cursor: pointer; border-radius: 3px; transition: background-color .2s; }
        .rack-selector-grid label:hover { background-color: rgba(255, 255, 255, .05); }
        .rack-selector-grid input { margin-right: .5rem; }

        .no-selection { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--border-color); font-style: italic; }
        
        .detail-rack-group h3 {
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--panel-bg-lighter);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .detail-rack-group .rack-controls { display: flex; gap: .5rem; }
        .detail-rack-group-title { display: flex; align-items: center; gap: .5rem; cursor: pointer; }
        
        .rack-photo-btn, .rack-reset-btn {
            background-color: var(--border-color);
            color: var(--text-light);
            border: none;
            padding: .25rem .5rem;
            border-radius: 4px;
            font-size: .8em;
            cursor: pointer;
            transition: background-color .2s;
            font-weight: 700;
        }
        .rack-photo-btn:hover, .rack-reset-btn:hover { background-color: #5a6c7d; }

        .progress-stats { display: flex; gap: 1rem; padding: .5rem; background-color: var(--bg-color); border-radius: 4px; margin-bottom: 1rem; font-size: .9em; }
        .progress-stats span { display: flex; align-items: center; gap: .25rem; }

        .mobile-view { display: none; }
        .offline-indicator { position: fixed; top: 10px; right: 10px; background-color: var(--error-color); color: #fff; padding: .5rem; border-radius: 4px; display: none; z-index: 3000; }
        .offline-indicator.show { display: block; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 4px; color: #fff; font-family: var(--font-mono); z-index: 1000; transform: translateX(calc(100% + 20px)); transition: transform .3s ease-in-out; }
        .notification.show { transform: translateX(0); }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--error-color); }
        .notification.info { background-color: var(--accent-color); }
        
        .modal-overlay, .search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility 0s .3s; }
        .modal-overlay.is-visible, .search-overlay.is-visible { opacity: 1; visibility: visible; transition: opacity .3s ease; }
        .modal-overlay { background-color: rgba(0, 0, 0, .7); }
        .search-overlay { background-color: rgba(0, 0, 0, .9); flex-direction: column; padding: 1rem; }
        
        .modal-content { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color-subtle); flex-shrink: 0; }
        .modal-header h2 { margin: 0; color: var(--text-light); font-size: 1.1em; }
        .modal-close-btn { background: none; border: none; color: var(--text-color); font-size: 2rem; cursor: pointer; line-height: 1; }
        .modal-body { overflow-y: auto; padding: 1rem; }
        .modal-body .form-group { margin-bottom: 1rem; }
        .modal-body label { display: block; margin-bottom: .5rem; color: var(--text-light); }
        .modal-body input, .modal-body textarea { width: 100%; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: .75rem; border-radius: 4px; font-size: 1rem; font-family: var(--font-mono); }
        .modal-body textarea { min-height: 120px; resize: vertical; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border-color-subtle); text-align: right; display: flex; justify-content: flex-end; gap: .5rem; flex-shrink: 0; }
        
        .device-data-group { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color-subtle); }
        .device-data-group:last-child { border-bottom: none; }
        .device-data-group h3 { color: var(--accent-color); margin: 0 0 1rem; font-size: 1em; }
        
        .instructions-modal details { border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 1rem; }
        .instructions-modal summary { padding: 1rem; cursor: pointer; background-color: var(--bg-color); color: var(--text-light); font-weight: 700; }
        .instructions-modal details[open] summary { border-bottom: 1px solid var(--border-color-subtle); }
        .instructions-modal ol { list-style-type: decimal; padding-left: 2rem; margin: 1rem 0; }
        .instructions-modal li { margin-bottom: .75rem; }
        .instructions-modal li strong { color: var(--accent-color); }
        .instructions-modal li .note { display: block; font-size: .9em; color: var(--warning-color); margin-top: .25rem; padding-left: 1rem; border-left: 2px solid var(--warning-color); white-space: pre-wrap; }
        
        .search-overlay__header { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .search-overlay__input { flex-grow: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: .75rem; border-radius: 4px; font-size: 1.1rem; }
        .search-overlay__input:focus { outline: none; border-color: var(--accent-color); }

        @media (max-width: 768px) {
            .desktop-view { display: none; }
            .mobile-view { display: flex; flex-direction: column; height: calc(100vh - 1rem); border: none; background-color: var(--panel-bg); border-radius: 6px; }
            .modal-content { max-width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
            body { padding: .5rem; }
            .mobile-panel { display: none; flex-direction: column; height: 100%; }
            .mobile-panel.active { display: flex; }
            .mobile-header { padding: .75rem; border-bottom: 1px solid var(--border-color-subtle); display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; flex-shrink: 0; }
            .mobile-panel-content { overflow-y: auto; flex-grow: 1; padding: 1rem; }
            .mobile-back-btn { cursor: pointer; color: var(--accent-color); background: none; border: none; font-size: 1.1rem; font-family: var(--font-mono); padding: 0; }
            .mobile-rack-item { display: flex; align-items: center; gap: .5rem; padding: .75rem; font-size: 1.1rem; border-bottom: 1px solid var(--border-color-subtle); cursor: pointer; }
            .mobile-main-category-header { background-color: var(--bg-color); color: var(--accent-color); padding: .5rem .75rem; font-weight: 700; margin-top: .5rem; border-radius: 4px; border-bottom: 1px solid var(--accent-color); }
            .mobile-main-list .mobile-rack-item:hover { background-color: rgba(255, 255, 255, .05); }
            .mobile-toolbar { padding: 1rem; border-top: 1px solid var(--border-color-subtle); display: flex; justify-content: space-around; align-items: center; font-size: 1.2rem; flex-shrink: 0; }
            .mobile-toolbar .btn { min-width: 40px; padding: .75rem; }
            
            .mobile-equipment-item { border: 1px solid var(--border-color-subtle); margin-bottom: 1rem; padding: 1rem; border-radius: 4px; background-color: var(--bg-color); }
            .mobile-equipment-header { display: flex; justify-content: space-between; align-items: flex-start; gap: .5rem; margin-bottom: .5rem; }
            .mobile-equipment-title { font-weight: 700; color: var(--text-light); flex-grow: 1; font-size: 1rem; }
            .mobile-equipment-controls { display: flex; gap: .5rem; align-items: center; }
            .mobile-status-toggle { width: 40px; height: 40px; border: 2px solid var(--border-color); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; border-radius: 4px; transition: all .2s; }
            .mobile-status-toggle.verified { border-color: var(--success-color); background-color: var(--success-color); color: #fff; }
            .mobile-status-toggle.failed { border-color: var(--error-color); background-color: var(--error-color); color: #fff; }
            .mobile-status-toggle.needs-review { border-color: var(--needs-review-color); background-color: var(--needs-review-color); color: #fff; }
            
            .mobile-toolbar .btn:active, .mobile-rack-item:active, .mobile-status-toggle:active, .note-btn:active, .data-btn:active, .photo-btn:active {
                transform: scale(.96);
                background-color: rgba(255, 255, 255, .1);
            }
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offline-indicator" role="status" aria-live="polite">
        📶 Working Offline
    </div>

    <div class="desktop-view" id="desktop-view">
        <header class="app-header" role="banner">
            <h1 class="header-title">📊 DC Deployment Checklist v6.0</h1>
            <div class="header-user"><span>DataCenter-1</span> | <span>Admin</span></div>
        </header>

        <div class="app-controls" role="search">
            <div class="view-toggle">
                <button class="btn" id="view-mode-category-btn">By Category</button>
                <button class="btn" id="view-mode-rack-btn">By Rack</button>
            </div>
            <input type="search" id="search-input" class="search-input" placeholder="Search equipment, cables..." aria-label="Search equipment, cables, racks">
            <button class="btn" id="clear-search-btn">Clear</button>
            <button class="btn" id="show-instructions-btn">📄 Instructions</button>
            <button class="btn" id="export-yaml-btn">📥 YAML</button>
            <button class="btn" id="export-csv-btn">📥 CSV</button>
            <button class="btn btn-secondary" id="import-btn">📤 Import</button>
            <button class="btn btn-secondary" id="backup-btn">💾 Backup</button>
            <button class="btn btn-secondary" id="reset-all-btn">🔄 Reset</button>
        </div>

        <aside class="panel panel-sidebar" role="navigation">
            <h2 class="panel-title" id="sidebar-title">📋 Categories</h2>
            <div class="progress-stats" id="overall-stats"></div>
            <div class="panel-content">
                <ul id="sidebar-list" class="sidebar-list"></ul>
            </div>
        </aside>

        <main class="panel panel-overview" role="region" aria-labelledby="overview-title">
            <h2 class="panel-title" id="overview-title">📊 Rack Overview</h2>
            <div id="rack-selector" class="rack-selector-container"></div>
            <div class="panel-content">
                <ul id="rack-overview-list" class="sidebar-list"></ul>
            </div>
        </main>

        <section class="panel panel-detail" role="region" aria-labelledby="detail-panel-title">
            <h2 class="panel-title" id="detail-panel-title">🔧 Equipment Detail</h2>
            <div class="panel-content" id="equipment-detail-content"></div>
        </section>
    </div>

    <div class="mobile-view" id="mobile-view">
        <div id="mobile-panel-main" class="mobile-panel active">
             <header class="mobile-header">
                <span>🏢 DC-1</span>
                <button class="btn btn-secondary" id="mobile-filter-racks-btn" style="padding: 0.25rem 0.5rem; font-size: 0.9em;">Filter Racks</button>
                <span id="mobile-total-progress"></span>
            </header>
            <div class="mobile-panel-content">
                <ul id="mobile-main-list" class="sidebar-list"></ul>
            </div>
            <footer class="mobile-toolbar">
                <button class="btn" id="mobile-show-instructions-btn" title="Instructions">📄</button>
                <button class="btn" id="mobile-export-yaml-btn" title="Export YAML">YAML</button>
                <button class="btn" id="mobile-export-csv-btn" title="Export CSV">CSV</button>
                <button class="btn btn-secondary" id="mobile-search-btn" title="Search">🔍</button>
                <button class="btn btn-secondary" id="mobile-backup-btn" title="Backup">💾</button>
                <button class="btn btn-secondary" id="mobile-reset-all-btn" title="Reset All">🔄</button>
            </footer>
        </div>

        <div id="mobile-panel-items" class="mobile-panel">
            <header class="mobile-header">
                <button class="mobile-back-btn" aria-label="Go back to main list">← Back</button>
                <h2 id="mobile-item-title" style="font-size: 1.1em; margin: 0;"></h2>
            </header>
            <div class="mobile-panel-content" id="mobile-item-list"></div>
        </div>
    </div>
    
    <div id="app-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <header class="modal-header">
                <h2 id="modal-title"></h2>
                <button class="modal-close-btn" aria-label="Close modal">&times;</button>
            </header>
            <div id="modal-body" class="modal-body"></div>
            <footer id="modal-footer" class="modal-footer"></footer>
        </div>
    </div>
    
    <div id="search-overlay" class="search-overlay">
        <div class="search-overlay__header">
            <input type="search" id="mobile-search-input" class="search-overlay__input" placeholder="Search everything...">
            <button id="close-search-overlay-btn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <script>
    /**
     * @file Data Center Interactive Checklist Application v6.0 (UX Optimized)
     * @description A standalone, client-side web application for tracking data center deployment tasks.
     * v6.0 implements a major UX overhaul based on HCI principles. It introduces a "View by Rack" mode,
     * refines the visual design for clarity, and places actions contextually for intuitive operation.
     *
     * @author Gemini AI Code Auditor
     * @version 6.0
     * @license MIT
     */
    (function() {
        'use strict';

        // #region DATA (Unchanged)
        const deploymentInstructionsData = [
            {
                phase: 'Phase 1: Physical Infrastructure Setup',
                steps: [
                    {
                        title: 'Step 1: Rack Installation',
                        note: 'Install all racks in their designated positions.\nLayout Rule: N-type racks followed by IT-type racks in each row.\nDefault: Two-row arrangements at every data center site (single-row possible but not recommended).'
                    },
                    {
                        title: 'Step 2: CPL Cabinet Installation (Optional)',
                        note: 'If CPL exists: Install the CPL (Cable Patching Location) cabinet with all its modules.'
                    },
                    {
                        title: 'Step 3: Mounting Rail Adjustment',
                        note: 'Adjust internal mounting rails within the racks to their proper positions to accommodate equipment.'
                    },
                    {
                        title: 'Step 4: ODF Module Installation (Optional)',
                        note: 'If ODF exists: Install all ODF (Optical Distribution Frame) modules into the racks.'
                    },
                    {
                        title: 'Step 5: Backbone Fiber Optic Cable Installation (Optional)',
                        note: 'If CPL exists:\n    - Install all backbone fiber optic cables (spliced or breakout) between the CPL and Meet-Me-Rooms (MMR).\n    - Install breakout fiber optic cables between the CPL and each rack ODF.\nCrucial: All backbone fiber optic cables must be measured, and measurement data documented.'
                    },
                    {
                        title: 'Step 6: PDU Socket Lock Installation (Optional)',
                        note: 'If Rittal PDUs (Power Distribution Units) are used: Install socket locks on PDUs at all planned power connector positions.\nReference: PDU power connection details are in each rack layout sheet in Annex 4.'
                    }
                ]
            },
            {
                phase: 'Phase 2: Equipment Installation and Cabling',
                steps: [
                    {
                        title: 'Step 7: Network Device Installation',
                        note: 'Install all network devices.\nRecord: Essential technical information (e.g., serial numbers, MAC addresses) in Annex 4.\nExamples of Devices: SPINE (Cisco Nexus 9336C-FX2), OAM FW (Juniper SRX1500), OAM AGG (Cisco Nexus 93180YC-FX3H), TOR BL (Cisco Nexus 93180YC-FX3H), TOR SW A/B (Cisco Nexus 93180YC-FX3H/FX3), BOR SW A/B (Cisco Nexus 92348GC-X), Console Server (Perle IOLAN SCS16C).'
                    },
                    {
                        title: 'Step 8: Server Installation',
                        note: 'Install all servers.\nRecord: Crucial technical information (e.g., serial numbers, ILO (Integrated Lights-Out) passwords) in Annex 4.\nExamples of Servers: Lenovo SR650 v3, Lenovo SR650 v2.'
                    },
                    {
                        title: 'Step 9: Device Labeling',
                        note: 'Label every installed device according to the specifications in each rack layout sheet.'
                    },
                    {
                        title: 'Step 10: Cable Labeling',
                        note: 'Label all UTP cables and fiber optic patch cables.\nOptional: Labeling DAC (Direct Attach Copper) cables.'
                    },
                    {
                        title: 'Step 11: Power Cord Installation',
                        note: 'Install power cords for every device.\nCrucial: Use socket locks (from Step 6) to secure power cords.'
                    },
                    {
                        title: 'Step 12: Fiber Optic Patch Cable Installation',
                        note: 'Install all fiber optic patch cables (e.g., CZ-FO00001).\nRegister: Cable IDs in the "FO Connections" sheet of Annex 4.'
                    },
                    {
                        title: 'Step 13: DAC Cable Installation',
                        note: 'Install all DAC cables (25G-25G 3m) between servers and TOR (Top of Rack) switches.'
                    },
                    {
                        title: 'Step 14: UTP Patch Cable Installation',
                        note: 'Install all UTP (RJ-45) patch cables.\n    - UTP Red Cable: For console connections.\n    - UTP Yellow Cable: For OAM1 connections.\n    - UTP Blue Cable: For ILO connections.\nRegister: Cable IDs in the "UTP OAM Connections" and "UTP Console Connections" sheets of Annex 4.'
                    }
                ]
            },
            {
                phase: 'Phase 3: Verification and Initial Configuration',
                steps: [
                    {
                        title: 'Step 15: Connection Verification',
                        note: 'Check every established connection.\nIndicator: Network and server equipment ports should display a blinking green light to confirm proper connectivity.'
                    },
                    {
                        title: 'Step 16: Disk Layout Application',
                        note: 'Apply the specified disk layout to Lenovo ThinkSystem SR650 v3 Servers.\nIf discrepancies are found: Swap disks in the front docking slots.\nDisk Layouts:\n    - CN (6.3/6.6): Slot 0 (960 GB), Slot 1 (960 GB), Slot 4 (3.2T), Slot 5 (3.2T)\n    - MN (6.5): Slot 0 (960 GB), Slot 1 (960 GB), Slot 4 (3.2T), Slot 5 (3.2T)\n    - SN (6.4): Slot 0 (3.2T), Slot 1 (3.2T), Slot 2 (3.2T), Slot 3 (3.2T), Slot 4 (960 GB), Slot 5 (960 GB), Slot 6 (3.2T), Slot 7 (3.2T), Slot 8 (3.2T), Slot 9 (3.2T)'
                    },
                    {
                        title: 'Step 17: Initial Server IMM Configuration',
                        note: '1. Connect keyboard and monitor to the server.\n2. Enter BIOS (typically F1 key).\n3. Set ILO/IMM (Integrated Management Module) network configuration (IP, Gateway, Mask) as defined below:\n    - Rack C01: IP: 100.85.30.x (x = rack unit position), Mask: 255.255.255.0, GW: 100.85.30.254\n    - Rack C02: IP: 100.85.40.x, Mask: 255.255.255.0, GW: 100.85.40.254\n    - Rack C03: IP: 100.85.50.x, Mask: 255.255.255.0, GW: 100.85.50.254\n    - Rack C04: IP: 100.85.60.x, Mask: 255.255.255.0, GW: 100.85.60.254\n    - Rack C05: IP: 100.85.70.x, Mask: 255.255.255.0, GW: 100.85.70.254\n    - Rack C06: IP: 100.85.80.x, Mask: 255.255.255.0, GW: 100.85.80.254\n4. Log out of BIOS.\n5. Report any hardware issues.\n6. Connect to ILO, change ILO password (User: USERID, Pass: -), and log out.'
                    },
                    {
                        title: 'Step 18: Infra1 Node Initial Bootstrap',
                        note: '1. Connect to ILO using a cable from a laptop.\n2. Log in.\n3. Map the Ubuntu 20.04.6-live-server-amd64.iso image as a virtual CD-ROM.\n4. Set the boot order to "1. cd-rom".\n5. Reboot the server.\n6. Install the operating system.\n7. Set network configuration (IP, GW, mask - details TBD by local service provider).\n8. Check hardware status.\n9. Verify Internet/external connectivity.\n10. Create a user: username=ubuntu, password=uTnUbU (with sudo rights).\n11. Execute `apt update && apt upgrade`.\n12. Log out.\n13. Notify the responsible engineer (share external IP, name, password).'
                    }
                ]
            }
        ];
        
        const definitiveDeviceList = {
            "C1 (N-MCS)": ["ODF (C1.47)", "Spine (C1.43)", "OAM FW (C1.42)", "AGG SW (C1.41)", "TOR_SW_BL (C1.39)", "TOR_SW_A (C1.37)", "TOR_SW_B (C1.35)", "BOR_SW_A (C1.4)", "BOR_SW_B (C1.2)", "Console Server (C1.3)", "PDU A (C1.PDU A)", "PDU B (C1.PDU B)", "Server (C1.20)", "Server (C1.18)", "Server (C1.16)", "Server (C1.14)", "Server (C1.12)", "Server (C1.10)", "Server (C1.8)", "Server (C1.6)"],
            "C2 (N-MCS)": ["ODF (C2.47)", "Spine (C2.43)", "OAM FW (C2.42)", "AGG SW (C2.41)", "TOR_SW_BL (C2.39)", "TOR_SW_A (C2.37)", "TOR_SW_B (C2.35)", "BOR_SW_A (C2.4)", "BOR_SW_B (C2.2)", "Console Server (C2.3)", "PDU A (C2.PDU A)", "PDU B (C2.PDU B)", "Server (C2.20)", "Server (C2.18)", "Server (C2.16)", "Server (C2.14)", "Server (C2.12)", "Server (C2.10)", "Server (C2.8)", "Server (C2.6)"],
            "C3 (MCS)": ["ODF (C3.47)", "TOR_SW_A (C3.45)", "TOR_SW_B (C3.43)", "BOR_SW_A (C3.4)", "BOR_SW_B (C3.2)", "PDU A (C3.PDU A)", "PDU B (C3.PDU B)", "Server (C3.20)", "Server (C3.18)", "Server (C3.16)", "Server (C3.14)", "Server (C3.12)", "Server (C3.10)", "Server (C3.8)", "Server (C3.6)"],
            "C4 (CS)": ["ODF (C4.47)", "TOR_SW_A (C4.45)", "TOR_SW_B (C4.43)", "BOR_SW_A (C4.4)", "BOR_SW_B (C4.2)", "PDU A (C4.PDU A)", "PDU B (C4.PDU B)", "Server (C4.22)", "Server (C4.20)", "Server (C4.18)", "Server (C4.16)", "Server (C4.14)", "Server (C4.12)", "Server (C4.10)", "Server (C4.8)", "Server (C4.6)"],
            "C5 (CS)": ["ODF (C5.47)", "TOR_SW_A (C5.45)", "TOR_SW_B (C5.43)", "BOR_SW_A (C5.4)", "BOR_SW_B (C5.2)", "PDU A (C5.PDU A)", "PDU B (C5.PDU B)", "Server (C5.22)", "Server (C5.20)", "Server (C5.18)", "Server (C5.16)", "Server (C5.14)", "Server (C5.12)", "Server (C5.10)", "Server (C5.8)", "Server (C5.6)"],
            "C6 (CS)": ["ODF (C6.47)", "TOR_SW_A (C6.45)", "TOR_SW_B (C6.43)", "BOR_SW_A (C6.4)", "BOR_SW_B (C6.2)", "PDU A (C6.PDU A)", "PDU B (C6.PDU B)", "Server (C6.22)", "Server (C6.20)", "Server (C6.18)", "Server (C6.16)", "Server (C6.14)", "Server (C6.12)", "Server (C6.10)", "Server (C6.8)", "Server (C6.6)"]
        };

        const fullRawData = {
            "C1 (N-MCS)": {
                "SFP Installation Verification": ["SPINE (C1.43) Ports 1-14: QSFP-100G-SM-SR", "OAM FW (C1.42) Port 15: SRX-SFP-1GE-LX (xconnect FW C2.42)", "OAM FW (C1.42) Ports 16-17: SRX-SFP-10GE-LR (to TOR BL C1.39)", "OAM FW (C1.42) HA CONTROL: SRX-SFP-1GE-LX (xconnect FW C2.42)", "OAM AGG (C1.41) Ports 1-6: GLC-LH-SMD", "OAM AGG (C1.41) Ports 47-48: SFP-10G-LR-S (xconnect AGG C2.41)", "TOR BL (C1.39) Ports 47-48: SFP-10G-LR-S (to FW C1.42)", "TOR BL (C1.39) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR BL (C1.39) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR BL (C1.39) Port 51: QSFP-100G-LR4-S (NatCo primary NNI link)", "TOR BL (C1.39) Ports 53-54: QSFP-100G-SM-SR (xconnect TORs C2.39)", "TOR (C1.37) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C1.37) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C1.37) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C1.35)", "TOR (C1.35) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C1.35) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C1.35) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C1.37)", "BOR (C1.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C1.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C1.2)", "BOR (C1.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C1.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C1.4)"],
                "Fiber Optic (FO) Connections": ["SPINE 1 (C1.43) Port 1 -> TOR BL 1 (C1.39) Port 49 (Cable: PL-FO00001)", "SPINE 1 (C1.43) Port 2 -> TOR BL 2 (C2.39) Port 49 (Cable: PL-FO00002)", "SPINE 1 (C1.43) Port 3 -> TOR A (C1.37) Port 49 (Cable: PL-FO00003)", "SPINE 1 (C1.43) Port 4 -> TOR B (C1.35) Port 49 (Cable: PL-FO00004)", "SPINE 1 (C1.43) Port 5 -> TOR A (C2.37) Port 49 (Cable: PL-FO00005)", "SPINE 1 (C1.43) Port 6 -> TOR B (C2.35) Port 49 (Cable: PL-FO00006)", "SPINE 1 (C1.43) Port 7 -> TOR A (C3.45) Port 49 (Cable: PL-FO00007)", "SPINE 1 (C1.43) Port 8 -> TOR B (C3.43) Port 49 (Cable: PL-FO00008)", "SPINE 1 (C1.43) Port 9 -> TOR A (C4.45) Port 49 (Cable: PL-FO00009)", "SPINE 1 (C1.43) Port 10 -> TOR B (C4.43) Port 49 (Cable: PL-FO00010)", "SPINE 1 (C1.43) Port 11 -> TOR A (C5.45) Port 49 (Cable: PL-FO00011)", "SPINE 1 (C1.43) Port 12 -> TOR B (C5.43) Port 49 (Cable: PL-FO00012)", "SPINE 1 (C1.43) Port 13 -> TOR A (C6.45) Port 49 (Cable: PL-FO00013)", "SPINE 1 (C1.43) Port 14 -> TOR B (C6.43) Port 49 (Cable: PL-FO00014)", "FW 1 (C1.42) Port 15 -> FW 2 (C2.42) Port 15 (Cable: PL-FO00015)", "FW 1 (C1.42) Port 16 -> TOR BL 1 (C1.39) Port 47 (Cable: PL-FO00016)", "FW 1 (C1.42) Port 17 -> TOR BL 1 (C1.39) Port 48 (Cable: PL-FO00017)", "FW 1 (C1.42) HA CONTROL -> FW 2 (C2.42) HA CONTROL (Cable: PL-FO00018)", "AGG 1 (C1.41) Port 1 -> BOR A (C1.4) Port 49 (Cable: PL-FO00019)", "AGG 1 (C1.41) Port 2 -> BOR B (C2.2) Port 49 (Cable: PL-FO00020)", "AGG 1 (C1.41) Port 3 -> BOR A (C3.4) Port 49 (Cable: PL-FO00021)", "AGG 1 (C1.41) Port 4 -> BOR B (C4.2) Port 49 (Cable: PL-FO00022)", "AGG 1 (C1.41) Port 5 -> BOR A (C5.4) Port 49 (Cable: PL-FO00023)", "AGG 1 (C1.41) Port 6 -> BOR B (C6.2) Port 49 (Cable: PL-FO00024)", "AGG 1 (C1.41) Port 47 -> AGG 2 (C2.41) Port 47 (Cable: PL-FO00025)", "AGG 1 (C1.41) Port 48 -> AGG 2 (C2.41) Port 48 (Cable: PL-FO00026)", "TOR BL 1 (C1.39) Port 51 -> NatCo NNI link (Cable: PL-FO00049)"],
                "UTP OAM Connections": ["Spine (C1.43) MGMT -> BOR SW A, Port 46", "FW (C1.42) MGMT -> BOR SW A, Port 44", "AGG SW (C1.41) MGMT -> BOR SW A, Port 43", "TOR_SW_BL (C1.39) MGMT -> BOR SW A, Port 42", "TOR_SW_A (C1.37) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C1.35) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C1.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C1.2) MGMT -> BOR SW A, Port 45", "PDU A (C1.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C1.PDU B) MGMT -> BOR SW B, Port 48", "Server (C1.20) ILO -> BOR SW A, Port 32", "Server (C1.18) ILO -> BOR SW A, Port 31", "Server (C1.16) ILO -> BOR SW A, Port 30", "Server (C1.14) ILO -> BOR SW A, Port 29", "Server (C1.12) ILO -> BOR SW A, Port 28", "Server (C1.10) ILO -> BOR SW A, Port 27", "Server (C1.8) ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "Server (C1.6) ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "UTP Console Connections": ["Console Server (C1.3) Eth1 -> BOR A (C1.2), Port 41", "Console Server (C1.3) Port 1 -> SPINE (C1.43), CON", "Console Server (C1.3) Port 2 -> FW (C1.42), CON", "Console Server (C1.3) Port 3 -> AGG (C1.41), CON", "Console Server (C1.3) Port 4 -> TOR BL (C1.39), CON"],
                "Rack Layout, Positioning, and Power": ["ODF (C1.47): RU 47", "Spine (C1.43) (N9K-C9336C-FX2): RU 43, PDU A 18, PDU B 18", "OAM FW (C1.42) (SRX1500-AC): RU 42, PDU A 8, PDU B 8", "AGG SW (C1.41) (N9K-C93180YC-FX3H): RU 41, PDU A 27, PDU B 27", "TOR_SW_BL (C1.39) (N9K-C93180YC-FX3H): RU 39, PDU A 17, PDU B 17", "TOR_SW_A (C1.37) (N9K-C93180YC-FX3H): RU 37, PDU A 7, PDU B 7", "TOR_SW_B (C1.35) (N9K-C93180YC-FX3H): RU 35, PDU A 26, PDU B 26", "BOR_SW_A (C1.4) (N9K-C92348GC-X): RU 4, PDU A 21, PDU B 21", "BOR_SW_B (C1.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Console Server (C1.3): RU 3", "Server (C1.20) (Lenovo SR650 v3): RU 21, PDU A 14, PDU B 14", "Server (C1.18) (Lenovo SR650 v3): RU 19, PDU A 4, PDU B 4", "Server (C1.16) (Lenovo SR650 v3): RU 17, PDU A 23, PDU B 23", "Server (C1.14) (Lenovo SR650 v3): RU 15, PDU A 13, PDU B 13", "Server (C1.12) (Lenovo SR650 v3): RU 13, PDU A 3, PDU B 3", "Server (C1.10) (Lenovo SR650 v3): RU 11, PDU A 22, PDU B 22", "Server (C1.8) (Lenovo SR650 v3): RU 9, PDU A 12, PDU B 12", "Server (C1.6) (Lenovo SR650 v3): RU 7, PDU A 2, PDU B 2", "PDU A (C1.PDU A): Vertical", "PDU B (C1.PDU B): Vertical"]
            },
            "C2 (N-MCS)": {
                "SFP Installation Verification": ["SPINE (C2.43) Ports 1-14: QSFP-100G-SM-SR", "OAM FW (C2.42) Port 15: SRX-SFP-1GE-LX (xconnect FW C1.42)", "OAM FW (C2.42) Ports 16-17: SRX-SFP-10GE-LR (to TOR BL C2.39)", "OAM FW (C2.42) HA CONTROL: SRX-SFP-1GE-LX (xconnect FW C1.42)", "OAM AGG (C2.41) Ports 1-6: GLC-LH-SMD", "OAM AGG (C2.41) Ports 47-48: SFP-10G-LR-S (xconnect AGG C1.41)", "TOR BL (C2.39) Ports 47-48: SFP-10G-LR-S (to FW C2.42)", "TOR BL (C2.39) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR BL (C2.39) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR BL (C2.39) Port 51: QSFP-100G-LR4-S (NatCo primary NNI link)", "TOR BL (C2.39) Ports 53-54: QSFP-100G-SM-SR (xconnect TORs C1.39)", "TOR (C2.37) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C2.37) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C2.37) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C2.35)", "TOR (C2.35) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C2.35) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C2.35) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C2.37)", "BOR (C2.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C2.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C2.2)", "BOR (C2.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C2.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C2.4)"],
                "Fiber Optic (FO) Connections": ["SPINE 2 (C2.43) Port 1 -> TOR BL 2 (C2.39) Port 50 (Cable: PL-FO00027)", "SPINE 2 (C2.43) Port 2 -> TOR BL 1 (C1.39) Port 50 (Cable: PL-FO00028)", "SPINE 2 (C2.43) Port 3 -> TOR A (C1.37) Port 50 (Cable: PL-FO00029)", "SPINE 2 (C2.43) Port 4 -> TOR B (C1.35) Port 50 (Cable: PL-FO00030)", "SPINE 2 (C2.43) Port 5 -> TOR A (C2.37) Port 50 (Cable: PL-FO00031)", "SPINE 2 (C2.43) Port 6 -> TOR B (C2.35) Port 50 (Cable: PL-FO00032)", "SPINE 2 (C2.43) Port 7 -> TOR A (C3.45) Port 50 (Cable: PL-FO00033)", "SPINE 2 (C2.43) Port 8 -> TOR B (C3.43) Port 50 (Cable: PL-FO00034)", "SPINE 2 (C2.43) Port 9 -> TOR A (C4.45) Port 50 (Cable: PL-FO00035)", "SPINE 2 (C2.43) Port 10 -> TOR B (C4.43) Port 50 (Cable: PL-FO00036)", "SPINE 2 (C2.43) Port 11 -> TOR A (C5.45) Port 50 (Cable: PL-FO00037)", "SPINE 2 (C2.43) Port 12 -> TOR B (C5.43) Port 50 (Cable: PL-FO00038)", "SPINE 2 (C2.43) Port 13 -> TOR A (C6.45) Port 50 (Cable: PL-FO00039)", "SPINE 2 (C2.43) Port 14 -> TOR B (C6.43) Port 50 (Cable: PL-FO00040)", "FW 2 (C2.42) Port 16 -> TOR BL 2 (C2.39) Port 47 (Cable: PL-FO00041)", "FW 2 (C2.42) Port 17 -> TOR BL 2 (C2.39) Port 48 (Cable: PL-FO00042)", "AGG 2 (C2.41) Port 1 -> BOR B (C1.2) Port 49 (Cable: PL-FO00043)", "AGG 2 (C2.41) Port 2 -> BOR A (C2.4) Port 49 (Cable: PL-FO00044)", "AGG 2 (C2.41) Port 3 -> BOR B (C3.2) Port 49 (Cable: PL-FO00045)", "AGG 2 (C2.41) Port 4 -> BOR A (C4.4) Port 49 (Cable: PL-FO00046)", "AGG 2 (C2.41) Port 5 -> BOR B (C5.2) Port 49 (Cable: PL-FO00047)", "AGG 2 (C2.41) Port 6 -> BOR A (C6.4) Port 49 (Cable: PL-FO00048)", "TOR BL 2 (C2.39) Port 51 -> NatCo NNI link (Cable: PL-FO00050)"],
                "UTP OAM Connections": ["Spine (C2.43) MGMT -> BOR SW A, Port 46", "FW (C2.42) MGMT -> BOR SW A, Port 44", "AGG SW (C2.41) MGMT -> BOR SW A, Port 43", "TOR_SW_BL (C2.39) MGMT -> BOR SW A, Port 42", "TOR_SW_A (C2.37) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C2.35) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C2.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C2.2) MGMT -> BOR SW A, Port 45", "PDU A (C2.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C2.PDU B) MGMT -> BOR SW B, Port 48", "Server (C2.20) ILO -> BOR SW A, Port 32", "Server (C2.18) ILO -> BOR SW A, Port 31", "Server (C2.16) ILO -> BOR SW A, Port 30", "Server (C2.14) ILO -> BOR SW A, Port 29", "Server (C2.12) ILO -> BOR SW A, Port 28", "Server (C2.10) ILO -> BOR SW A, Port 27", "Server (C2.8) ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "Server (C2.6) ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "UTP Console Connections": ["Console Server (C2.3) Eth1 -> BOR A (C2.2), Port 41", "Console Server (C2.3) Port 1 -> SPINE (C2.43), CON", "Console Server (C2.3) Port 2 -> FW (C2.42), CON", "Console Server (C2.3) Port 3 -> AGG (C2.41), CON", "Console Server (C2.3) Port 4 -> TOR BL (C2.39), CON"],
                "Rack Layout, Positioning, and Power": ["ODF (C2.47): RU 47", "Spine (C2.43) (N9K-C9336C-FX2): RU 43, PDU A 18, PDU B 18", "OAM FW (C2.42) (SRX1500-AC): RU 42, PDU A 8, PDU B 8", "AGG SW (C2.41) (N9K-C93180YC-FX3H): RU 41, PDU A 27, PDU B 27", "TOR_SW_BL (C2.39) (N9K-C93180YC-FX3H): RU 39, PDU A 17, PDU B 17", "TOR_SW_A (C2.37) (N9K-C93180YC-FX3H): RU 37, PDU A 7, PDU B 7", "TOR_SW_B (C2.35) (N9K-C93180YC-FX3H): RU 35, PDU A 26, PDU B 26", "BOR_SW_A (C2.4) (N9K-C92348GC-X): RU 4, PDU A 21, PDU B 21", "BOR_SW_B (C2.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Console Server (C2.3): RU 3", "Server (C2.20) (Lenovo SR650 v3): RU 21, PDU A 14, PDU B 14", "Server (C2.18) (Lenovo SR650 v3): RU 19, PDU A 4, PDU B 4", "Server (C2.16) (Lenovo SR650 v3): RU 17, PDU A 23, PDU B 23", "Server (C2.14) (Lenovo SR650 v3): RU 15, PDU A 13, PDU B 13", "Server (C2.12) (Lenovo SR650 v3): RU 13, PDU A 3, PDU B 3", "Server (C2.10) (Lenovo SR650 v3): RU 11, PDU A 22, PDU B 22", "Server (C2.8) (Lenovo SR650 v3): RU 9, PDU A 12, PDU B 12", "Server (C2.6) (Lenovo SR650 v3): RU 7, PDU A 2, PDU B 2", "PDU A (C2.PDU A): Vertical", "PDU B (C2.PDU B): Vertical"]
            },
            "C3 (MCS)": {
                "SFP Installation Verification": ["TOR (C3.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C3.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C3.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C3.43)", "TOR (C3.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C3.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C3.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C3.45)", "BOR (C3.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C3.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C3.2)", "BOR (C3.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C3.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C3.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C3.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C3.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C3.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C3.2) MGMT -> BOR SW A, Port 45", "PDU A (C3.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C3.PDU B) MGMT -> BOR SW B, Port 48", "Server (C3.20) ILO -> BOR SW A, Port 32", "Server (C3.18) ILO -> BOR SW A, Port 31", "Server (C3.16) ILO -> BOR SW A, Port 30", "Server (C3.14) ILO -> BOR SW A, Port 29", "Server (C3.12) ILO -> BOR SW A, Port 28", "Server (C3.10) ILO -> BOR SW A, Port 27", "Server (C3.8) ILO -> BOR SW A, Port 26; OAM1 -> BOR SW A, Port 2; OAM2 -> BOR SW B, Port 2", "Server (C3.6) ILO -> BOR SW A, Port 25; OAM1 -> BOR SW A, Port 1; OAM2 -> BOR SW B, Port 1"],
                "Rack Layout, Positioning, and Power": ["ODF (C3.47): RU 47", "TOR_SW_A (C3.45) (N9K-C93180YC-FX3H): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C3.43) (N9K-C93180YC-FX3H): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C3.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C3.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C3.20) (Lenovo SR650 v3): RU 21, PDU A 4, PDU B 4", "Server (C3.18) (Lenovo SR650 v3): RU 19, PDU A 23, PDU B 23", "Server (C3.16) (Lenovo SR650 v3): RU 17, PDU A 13, PDU B 13", "Server (C3.14) (Lenovo SR650 v3): RU 15, PDU A 3, PDU B 3", "Server (C3.12) (Lenovo SR650 v3): RU 13, PDU A 22, PDU B 22", "Server (C3.10) (Lenovo SR650 v3): RU 11, PDU A 12, PDU B 12", "Server (C3.8) (Lenovo SR650 v3): RU 9, PDU A 2, PDU B 2", "Server (C3.6) (Lenovo SR650 v3): RU 7, PDU A 21, PDU B 21", "PDU A (C3.PDU A): Vertical", "PDU B (C3.PDU B): Vertical"]
            },
            "C4 (CS)": {
                "SFP Installation Verification": ["TOR (C4.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C4.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C4.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C4.43)", "TOR (C4.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C4.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C4.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C4.45)", "BOR (C4.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C4.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C4.2)", "BOR (C4.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C4.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C4.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C4.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C4.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C4.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C4.2) MGMT -> BOR SW A, Port 45", "PDU A (C4.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C4.PDU B) MGMT -> BOR SW B, Port 48", "Server (C4.22) IMM -> BOR SW B, Port 25", "Server (C4.20) IMM -> BOR SW A, Port 32", "Server (C4.18) IMM -> BOR SW A, Port 31", "Server (C4.16) IMM -> BOR SW A, Port 30", "Server (C4.14) IMM -> BOR SW A, Port 29", "Server (C4.12) IMM -> BOR SW A, Port 28", "Server (C4.10) IMM -> BOR SW A, Port 27", "Server (C4.8) IMM -> BOR SW A, Port 26", "Server (C4.6) IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF (C4.47): RU 47", "TOR_SW_A (C4.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C4.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C4.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C4.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C4.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C4.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C4.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C4.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C4.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C4.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C4.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C4.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C4.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12", "PDU A (C4.PDU A): Vertical", "PDU B (C4.PDU B): Vertical"]
            },
            "C5 (CS)": {
                "SFP Installation Verification": ["TOR (C5.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C5.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C5.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C5.43)", "TOR (C5.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C5.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C5.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C5.45)", "BOR (C5.4) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C5.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C5.2)", "BOR (C5.2) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C5.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C5.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C5.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C5.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C5.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C5.2) MGMT -> BOR SW A, Port 45", "PDU A (C5.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C5.PDU B) MGMT -> BOR SW B, Port 48", "Server (C5.22) IMM -> BOR SW B, Port 25", "Server (C5.20) IMM -> BOR SW A, Port 32", "Server (C5.18) IMM -> BOR SW A, Port 31", "Server (C5.16) IMM -> BOR SW A, Port 30", "Server (C5.14) IMM -> BOR SW A, Port 29", "Server (C5.12) IMM -> BOR SW A, Port 28", "Server (C5.10) IMM -> BOR SW A, Port 27", "Server (C5.8) IMM -> BOR SW A, Port 26", "Server (C5.6) IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF (C5.47): RU 47", "TOR_SW_A (C5.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C5.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C5.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C5.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C5.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C5.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C5.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C5.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C5.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C5.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C5.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C5.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C5.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12", "PDU A (C5.PDU A): Vertical", "PDU B (C5.PDU B): Vertical"]
            },
            "C6 (CS)": {
                "SFP Installation Verification": ["TOR (C6.45) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C6.45) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C6.45) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C6.43)", "TOR (C6.43) Port 49: QSFP-100G-SM-SR (to Spine C1.43)", "TOR (C6.43) Port 50: QSFP-100G-SM-SR (to Spine C2.43)", "TOR (C6.43) Ports 53-54: QSFP-100G-CU2M (xconnect TORs C6.45)", "BOR (C6.4) Port 49: GLC-LH-SMD (to AGG C2.41)", "BOR (C6.4) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C6.2)", "BOR (C6.2) Port 49: GLC-LH-SMD (to AGG C1.41)", "BOR (C6.2) Ports 51-52: SFP-H10GB-CU3M (xconnect BORs C6.4)"],
                "UTP OAM Connections": ["TOR_SW_A (C6.45) MGMT -> BOR SW A, Port 47", "TOR_SW_B (C6.43) MGMT -> BOR SW B, Port 47", "BOR_SW_A (C6.4) MGMT -> BOR SW B, Port 45", "BOR_SW_B (C6.2) MGMT -> BOR SW A, Port 45", "PDU A (C6.PDU A) MGMT -> BOR SW A, Port 48", "PDU B (C6.PDU B) MGMT -> BOR SW B, Port 48", "C6.22 Server IMM -> BOR SW B, Port 25", "C6.20 Server IMM -> BOR SW A, Port 32", "C6.18 Server IMM -> BOR SW A, Port 31", "C6.16 Server IMM -> BOR SW A, Port 30", "C6.14 Server IMM -> BOR SW A, Port 29", "C6.12 Server IMM -> BOR SW A, Port 28", "C6.10 Server IMM -> BOR SW A, Port 27", "C6.8 Server IMM -> BOR SW A, Port 26", "C6.6 Server IMM -> BOR SW A, Port 25"],
                "Rack Layout, Positioning, and Power": ["ODF (C6.47): RU 47", "TOR_SW_A (C6.45) (N9K-C93180YC-FX3): RU 45, PDU A 8, PDU B 8", "TOR_SW_B (C6.43) (N9K-C93180YC-FX3): RU 43, PDU A 27, PDU B 27", "BOR_SW_A (C6.4) (N9K-C92348GC-X): RU 4, PDU A 11, PDU B 11", "BOR_SW_B (C6.2) (N9K-C92348GC-X): RU 2, PDU A 1, PDU B 1", "Server (C6.22) (Lenovo SR650 v2): RU 23, PDU A 5, PDU B 5", "Server (C6.20) (Lenovo SR650 v2): RU 21, PDU A 24, PDU B 24", "Server (C6.18) (Lenovo SR650 v2): RU 19, PDU A 14, PDU B 14", "Server (C6.16) (Lenovo SR650 v2): RU 17, PDU A 4, PDU B 4", "Server (C6.14) (Lenovo SR650 v2): RU 15, PDU A 23, PDU B 23", "Server (C6.12) (Lenovo SR650 v2): RU 13, PDU A 13, PDU B 13", "Server (C6.10) (Lenovo SR650 v2): RU 11, PDU A 3, PDU B 3", "Server (C6.8) (Lenovo SR650 v2): RU 9, PDU A 22, PDU B 22", "Server (C6.6) (Lenovo SR650 v2): RU 7, PDU A 12, PDU B 12", "PDU A (C6.PDU A): Vertical", "PDU B (C6.PDU B): Vertical"]
            }
        };
        // #endregion

        // #region STATE & CONFIG
        let state = {};
        const config = {
            racks: {},
            categories: [],
            version: '6.0',
            allItems: {}
        };
        const statusCycle = ['pending', 'verified', 'failed', 'needs-review'];
        const localStorageKey = 'dcChecklistState_v6';
        // #endregion

        // #region CORE LOGIC & INITIALIZATION
        function init() {
            parseData();
            loadState();
            setupEventListeners();
            setupOfflineHandling();

            if (!state.activeCategory && config.categories.length > 0) {
                state.activeCategory = config.categories[0];
            }
            if (!state.activeRack && Object.keys(config.racks).length > 0) {
                state.activeRack = Object.keys(config.racks)[0];
            }
            if (Object.keys(state.selectedRacks).length === 0) {
                Object.keys(config.racks).forEach(rackId => {
                    state.selectedRacks[rackId] = true;
                });
            }

            renderAppLayout();
            renderMobile();
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(localStorageKey);
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    if (parsed && typeof parsed.itemStatus === 'object') {
                        state = parsed;
                        // Ensure new state properties exist
                        if (!state.viewMode) state.viewMode = 'category';
                        return;
                    }
                }
            } catch (e) {
                console.error("Failed to load state, backing up corrupted data.", e);
                const corruptedData = localStorage.getItem(localStorageKey);
                if (corruptedData) {
                    localStorage.setItem(`dcChecklistState_corrupted_${Date.now()}`, corruptedData);
                }
            }
            // Initialize with default state
            state = {
                itemStatus: {},
                itemNotes: {},
                itemTimestamps: {},
                rackPhotos: {},
                itemData: {},
                deviceData: {},
                activeCategory: null,
                activeRack: null,
                selectedRacks: {},
                mobileView: 'main',
                mobileRack: null,
                searchTerm: '',
                technicianId: 'Anonymous',
                isOnline: navigator.onLine,
                viewMode: 'category', // 'category' or 'rack'
            };
        }

        const saveState = debounce(() => {
            try {
                state.lastSaved = new Date().toISOString();
                state.version = config.version;
                localStorage.setItem(localStorageKey, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
                showNotification("Failed to save progress", "error");
            }
        }, 500);
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function parseData() {
            const uniqueCategories = new Set();
            Object.keys(fullRawData).forEach(rackName => {
                config.racks[rackName] = { name: rackName, items: [] };
                const rackData = fullRawData[rackName];
                Object.keys(rackData).forEach(categoryName => {
                    uniqueCategories.add(categoryName);
                    rackData[categoryName].forEach((itemString, index) => {
                        const [title, ...detailsParts] = itemString.split(': ');
                        const details = detailsParts.length > 0 ? detailsParts.join(': ') : '';
                        const itemId = `${sanitizeForId(rackName)}-${sanitizeForId(categoryName)}-${index}`;
                        const item = { id: itemId, title, details, category: categoryName, rack: rackName, notes: '' };
                        config.racks[rackName].items.push(item);
                        config.allItems[itemId] = item;
                    });
                });
            });
            config.categories = Array.from(uniqueCategories).sort();
        }
        // #endregion

        // #region DATA & PHOTO MODALS
        function openItemDataModal(itemId) {
            const item = config.allItems[itemId];
            if (!item) return;

            const itemType = getDeviceType(item);

            let bodyHtml, footerButtons, field, label, currentValue, deviceName;

            const saveHandler = (value) => {
                if (itemType === 'cable') {
                    if (!state.itemData) state.itemData = {};
                    state.itemData[itemId] = { cableId: value };
                } else {
                    if (!state.deviceData) state.deviceData = {};
                    if (!state.deviceData[item.rack]) state.deviceData[item.rack] = {};
                    if (!state.deviceData[item.rack][deviceName]) state.deviceData[item.rack][deviceName] = {};
                    state.deviceData[item.rack][deviceName][field] = value;
                }
                saveState();
                updateUI({ item: itemId });
                modal.hide();
            };

            switch (itemType) {
                case 'cable':
                    field = 'cableId';
                    label = 'Cable ID';
                    currentValue = (state.itemData && state.itemData[itemId]?.cableId) || '';
                    break;
                case 'server':
                case 'network':
                    field = event.target.dataset.field; // S/N, ILO, or MAC
                    deviceName = event.target.dataset.deviceName;
                    label = { serial: 'Serial Number', ilo: 'ILO Password', mac: 'MAC Address' }[field];
                    currentValue = state.deviceData?.[item.rack]?.[deviceName]?.[field] || '';
                    break;
                default:
                    showNotification("No data points for this item type.", "info");
                    return;
            }

            bodyHtml = `
                <div class="form-group">
                    <label for="data-input-field">${label} for ${escapeHTML(item.title)}</label>
                    <input type="text" id="data-input-field" value="${escapeHTML(currentValue)}">
                </div>
            `;
            footerButtons = [{
                label: 'Save',
                className: 'btn',
                onClick: () => {
                    const input = document.getElementById('data-input-field');
                    saveHandler(input.value);
                }
            }];

            modal.show({
                title: `Enter Data`,
                body: bodyHtml,
                footerButtons
            });
             setTimeout(() => document.getElementById('data-input-field').focus(), 100);
        }

        function handleRackPhoto(rackId) {
            const existingPhoto = state.rackPhotos[rackId];
            if (existingPhoto) {
                viewRackPhoto(rackId);
            } else {
                captureRackPhoto(rackId);
            }
        }

        function captureRackPhoto(rackId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.rackPhotos[rackId] = {
                            data: e.target.result,
                            timestamp: new Date().toISOString()
                        };
                        saveState();
                        updateUI({ rackPhoto: rackId });
                        showNotification(`Photo added for rack ${rackId}`, "success");
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function viewRackPhoto(rackId) {
            const photo = state.rackPhotos[rackId];
            if (!photo) return;
            
            const bodyHtml = `<img src="${photo.data}" style="width: 100%; height: 100%; object-fit: contain;" alt="Photo for rack ${rackId}">`;
            
            modal.show({
                title: `Photo for ${rackId}`,
                body: bodyHtml,
                footerButtons: [{
                    label: 'Delete',
                    className: 'btn btn-secondary',
                    onClick: () => {
                        modal.hide();
                        deleteRackPhoto(rackId);
                    }
                }]
            });
        }
        
        function deleteRackPhoto(rackId) {
            modal.show({
                title: `Delete Photo for ${rackId}?`,
                body: `<p>Are you sure you want to delete the photo for rack ${rackId}?</p>`,
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    { 
                        label: 'Delete',
                        className: 'btn',
                        onClick: () => {
                            delete state.rackPhotos[rackId];
                            saveState();
                            updateUI({ rackPhoto: rackId });
                            showNotification(`Photo for rack ${rackId} deleted.`, 'success');
                            modal.hide();
                        }
                    }
                ]
            });
        }
        // #endregion

        // #region UTILITIES
        function triggerVibration() {
            if (navigator.vibrate) navigator.vibrate(10);
        }
        
        function getCategoryProgress(categoryName = null) {
            let verified = 0, failed = 0, needsReview = 0, total = 0;
            const items = categoryName 
                ? Object.values(config.allItems).filter(i => i.category === categoryName && state.selectedRacks[i.rack])
                : Object.values(config.allItems).filter(i => state.selectedRacks[i.rack]);
            
            total = items.length;
            items.forEach(item => {
                const status = state.itemStatus[item.id];
                if (status === 'verified') verified++;
                else if (status === 'failed') failed++;
                else if (status === 'needs-review') needsReview++;
            });
            return { verified, failed, needsReview, checked: verified + failed + needsReview, total };
        }

        function getRackProgress(rackId, categoryName = null) {
            let verified = 0, failed = 0, needsReview = 0, total = 0;
            const rack = config.racks[rackId];
            if (!rack) return { verified: 0, failed: 0, needsReview: 0, checked: 0, total: 0 };
            
            const items = categoryName ? rack.items.filter(i => i.category === categoryName) : rack.items;

            items.forEach(item => {
                total++;
                const status = state.itemStatus[item.id];
                if (status === 'verified') verified++;
                else if (status === 'failed') failed++;
                else if (status === 'needs-review') needsReview++;
            });
            return { verified, failed, needsReview, checked: verified + failed + needsReview, total };
        }

        function getCategoryStatus(progress) {
            const { total, verified, failed, needsReview, checked } = progress;
            if (total === 0 || checked === 0) return 'pending';
            if (verified === total) return 'verified';
            if (failed > 0) return 'failed';
            if (needsReview > 0) return 'needs-review';
            if (checked > 0) return 'in-progress';
            return 'pending';
        }

        function getStatusIcon(status) {
            return { 'verified': '✓', 'failed': '✗', 'needs-review': '!', 'in-progress': '◐' }[status] || '';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        function setupOfflineHandling() {
            updateOnlineStatus();
        }

        function updateOnlineStatus() {
            document.getElementById('offline-indicator').classList.toggle('show', !state.isOnline);
        }

        function sanitizeForId(text) {
            return text.replace(/[^a-zA-Z0-9]/g, "_");
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match]));
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // #endregion
        
        // #region MODAL SYSTEM
        function showInstructionsModal() {
            const bodyHtml = deploymentInstructionsData.map(phase => `
                <details ${phase.phase.includes('Phase 1') ? 'open' : ''}>
                    <summary>${escapeHTML(phase.phase)}</summary>
                    <ol>
                    ${phase.steps.map(step => `
                        <li>
                            <strong>${escapeHTML(step.title)}</strong>
                            ${step.note ? `<span class="note">${escapeHTML(step.note)}</span>` : ''}
                        </li>
                    `).join('')}
                    </ol>
                </details>
            `).join('');
            modal.show({
                title: "Data Center Hardware Installation",
                body: bodyHtml,
                className: 'instructions-modal'
            });
        }
        
        const modal = (function buildModal() {
            const modalEl = document.getElementById('app-modal');
            const dialogEl = modalEl.querySelector('[role="dialog"]');
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            let firstFocusableEl, lastFocusableEl, previouslyFocusedEl;

            function keydownHandler(e) {
                if (e.key === 'Escape') {
                    hide();
                }
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusableEl) { lastFocusableEl.focus(); e.preventDefault(); }
                    } else {
                        if (document.activeElement === lastFocusableEl) { firstFocusableEl.focus(); e.preventDefault(); }
                    }
                }
            }

            function clickHandler(e) {
                if (e.target === modalEl) hide();
            }

            function show({ title, body, footerButtons = [], className }) {
                modalEl.querySelector('#modal-title').textContent = title;
                modalEl.querySelector('#modal-body').innerHTML = body;
                const footerEl = modalEl.querySelector('#modal-footer');
                footerEl.innerHTML = '';
                footerButtons.forEach(btnConfig => {
                    const btn = document.createElement('button');
                    btn.textContent = btnConfig.label;
                    btn.className = btnConfig.className || 'btn';
                    btn.onclick = btnConfig.onClick;
                    footerEl.appendChild(btn);
                });
                
                dialogEl.className = `modal-content ${className || ''}`;
                modalEl.classList.add('is-visible');
                previouslyFocusedEl = document.activeElement;
                const focusable = modalEl.querySelectorAll(focusableElements);
                firstFocusableEl = focusable[0];
                lastFocusableEl = focusable[focusable.length - 1];
                setTimeout(() => { (firstFocusableEl || dialogEl).focus() }, 100);
                modalEl.addEventListener('keydown', keydownHandler);
                modalEl.addEventListener('click', clickHandler);
            }

            function hide() {
                modalEl.classList.remove('is-visible');
                if (previouslyFocusedEl) previouslyFocusedEl.focus();
                modalEl.removeEventListener('keydown', keydownHandler);
                modalEl.removeEventListener('click', clickHandler);
            }

            return { show, hide };
        })();
        // #endregion

        // #region UI RENDERING & UPDATES
        
        function updateUI({ category, rack, item, all = false, stats = false, rackSelection = false, rackPhoto, viewModeChange = false }) {
            if (all || stats || rackSelection || viewModeChange) {
                renderAppLayout();
                renderMobile();
                return;
            }
            if (rackPhoto) {
                const indicators = document.querySelectorAll(`.rack-photo-indicator[data-rack-id="${rackPhoto}"]`);
                const hasPhoto = state.rackPhotos[rackPhoto] ? '<span style="color: var(--success-color);">📸</span>' : '';
                indicators.forEach(ind => ind.innerHTML = hasPhoto);
            }
            if (item) updateItemUI(item);
            if (category) updateCategoryUI(category);
            if (rack) updateRackUI(rack);
            updateOverallStatsUI();
        }

        function renderAppLayout() {
            document.getElementById('desktop-view').classList.toggle('rack-view', state.viewMode === 'rack');
            document.getElementById('view-mode-category-btn').classList.toggle('active', state.viewMode === 'category');
            document.getElementById('view-mode-rack-btn').classList.toggle('active', state.viewMode === 'rack');

            renderRackSelector();
            updateOverallStatsUI();
            
            if (state.viewMode === 'rack') {
                renderRackListSidebar();
                renderDetailForSelectedRack();
            } else {
                renderCategoryListSidebar();
                renderRackOverview();
                renderEquipmentDetailByCategory();
            }
        }

        function updateOverallStatsUI() {
            const progress = getCategoryProgress();
            const statsEl = document.getElementById('overall-stats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <span title="Verified"><div class="status-icon verified">✓</div> ${progress.verified}</span>
                    <span title="Failed"><div class="status-icon failed">✗</div> ${progress.failed}</span>
                    <span title="Needs Review"><div class="status-icon needs-review">!</div> ${progress.needsReview}</span>
                    <span title="Total">Σ ${progress.total}</span>
                `;
            }

            const mobileProgressEl = document.getElementById('mobile-total-progress');
            if(mobileProgressEl) {
                const percentage = progress.total > 0 ? Math.round(progress.verified / progress.total * 100) : 0;
                mobileProgressEl.textContent = `📊 ${percentage}%`;
            }
        }

        function renderRackSelector() {
            const containers = document.querySelectorAll(".rack-selector-container");
            const rackIds = Object.keys(config.racks);
            const allSelected = rackIds.length > 0 && rackIds.every(id => state.selectedRacks[id]);
            let html = '<div class="rack-selector-grid">';
            html += `<label><input type="checkbox" value="all" ${allSelected ? "checked" : ""}> <span>All</span></label>`;
            rackIds.forEach(id => {
                const checked = state.selectedRacks[id] ? "checked" : "";
                const shortName = id.split(" ")[0];
                html += `<label><input type="checkbox" value="${id}" ${checked}> <span>${shortName}</span></label>`;
            });
            html += "</div>";
            containers.forEach(c => c.innerHTML = html);
        }
        
        // --- BY CATEGORY VIEW ---
        function renderCategoryListSidebar() {
            document.getElementById("sidebar-title").textContent = "📋 Categories";
            const container = document.getElementById("sidebar-list");
            if (!container) return;
            container.innerHTML = config.categories.map(generateCategoryHTML).join('');
        }

        function updateCategoryUI(categoryId) {
            const el = document.querySelector(`.sidebar-list-item[data-category-id="${categoryId}"]`);
            if (el) el.outerHTML = generateCategoryHTML(categoryId);
        }
        
        function generateCategoryHTML(categoryName) {
            const progress = getCategoryProgress(categoryName);
            const status = getCategoryStatus(progress);
            const activeClass = state.activeCategory === categoryName ? "active" : "";
            return `
                <li class="sidebar-list-item ${activeClass}" data-category-id="${categoryName}" tabindex="0" role="button">
                    <span class="status-icon ${status}">${getStatusIcon(status)}</span>
                    ${categoryName}
                    <small>(${progress.checked}/${progress.total})</small>
                </li>`;
        }
        
        function renderRackOverview() {
            const container = document.getElementById("rack-overview-list");
            if (!container || !state.activeCategory) return;
            container.innerHTML = Object.keys(config.racks)
                .filter(rackId => state.selectedRacks[rackId])
                .map(generateRackOverviewHTML)
                .join('');
        }

        function updateRackUI(rackId) {
             const overviewEl = document.querySelector(`.rack-list-item[data-rack-id="${rackId}"]`);
             if (overviewEl) overviewEl.outerHTML = generateRackOverviewHTML(rackId);
             
             const sidebarEl = document.querySelector(`.sidebar-list-item[data-rack-id="${rackId}"]`);
             if (sidebarEl) sidebarEl.outerHTML = generateRackSidebarHTML(rackId);
        }
        
        function generateRackOverviewHTML(rackId) {
            const progress = getRackProgress(rackId, state.activeCategory);
            if (progress.total === 0) return '';
            const percentage = progress.total > 0 ? (progress.verified / progress.total) * 100 : 0;
            const shortName = rackId.split(" ")[0];
             return `
                <li class="rack-list-item" data-rack-id="${rackId}">
                    <button class="rack-list-item-main" data-rack-id="${rackId}" aria-label="Scroll to ${rackId} details">
                        <div class="rack-name">${shortName}</div>
                        <div class="rack-progress-bar" role="progressbar" aria-valuenow="${percentage}"><div class="rack-progress-fill" style="width:${percentage}%;"></div></div>
                        <span class="percentage">${Math.round(percentage)}%</span>
                    </button>
                </li>`;
        }

        function renderEquipmentDetailByCategory() {
            const container = document.getElementById("equipment-detail-content");
            const titleEl = document.getElementById("detail-panel-title");

            if (!container || !titleEl || !state.activeCategory) {
                container.innerHTML = '<div class="no-selection">Select a Category to view details</div>';
                titleEl.textContent = "🔧 Equipment Detail";
                return;
            }

            titleEl.textContent = `🔧 ${state.activeCategory}`;
            const searchTerm = state.searchTerm.toLowerCase();
            container.innerHTML = Object.keys(config.racks).filter(rackId => state.selectedRacks[rackId]).map(rackId => {
                const items = config.racks[rackId].items.filter(item =>
                    item.category === state.activeCategory &&
                    (!searchTerm || item.title.toLowerCase().includes(searchTerm) || item.details.toLowerCase().includes(searchTerm))
                );
                if (items.length === 0) return '';
                
                const allVerified = items.every(item => state.itemStatus[item.id] === "verified");
                const hasPhoto = state.rackPhotos[rackId] ? '<span style="color: var(--success-color);">📸</span>' : '';

                return `
                    <div class="detail-rack-group">
                        <h3 id="detail-rack-${sanitizeForId(rackId)}">
                            <label class="detail-rack-group-title" data-rack-id="${rackId}">
                                <input type="checkbox" class="rack-master-check" data-rack-id="${rackId}" ${allVerified ? "checked" : ""}>
                                <span>${rackId} <span class="rack-photo-indicator" data-rack-id="${rackId}">${hasPhoto}</span></span>
                            </label>
                            <div class="rack-controls">
                                <button class="rack-photo-btn" data-rack-id="${rackId}" title="Add or View Rack Photo">📷 Photo</button>
                                <button class="rack-reset-btn" data-rack-id="${rackId}" title="Reset Progress for ${rackId}">🔄 Reset</button>
                            </div>
                        </h3>
                        <ul class="equipment-list">${items.map(generateItemHTML).join('')}</ul>
                    </div>`;
            }).join('') || '<div class="no-selection">No items match your selection or search.</div>';
        }

        // --- BY RACK VIEW ---
        function renderRackListSidebar() {
            document.getElementById("sidebar-title").textContent = "🏢 Racks";
            const container = document.getElementById("sidebar-list");
            if (!container) return;
            container.innerHTML = Object.keys(config.racks).map(generateRackSidebarHTML).join('');
        }

        function generateRackSidebarHTML(rackId) {
            const progress = getRackProgress(rackId);
            const status = getCategoryStatus(progress);
            const activeClass = state.activeRack === rackId ? "active" : "";
            return `
                <li class="sidebar-list-item ${activeClass}" data-rack-id="${rackId}" tabindex="0" role="button">
                    <span class="status-icon ${status}">${getStatusIcon(status)}</span>
                    ${rackId}
                    <small>(${progress.checked}/${progress.total})</small>
                </li>`;
        }

        function renderDetailForSelectedRack() {
            const container = document.getElementById("equipment-detail-content");
            const titleEl = document.getElementById("detail-panel-title");

            if (!container || !titleEl || !state.activeRack) {
                container.innerHTML = '<div class="no-selection">Select a Rack to view details</div>';
                titleEl.textContent = "🔧 Equipment Detail";
                return;
            }
            
            titleEl.textContent = `🔧 ${state.activeRack}`;
            const searchTerm = state.searchTerm.toLowerCase();
            const items = config.racks[state.activeRack].items.filter(item => 
                !searchTerm || item.title.toLowerCase().includes(searchTerm) || item.details.toLowerCase().includes(searchTerm)
            );
            
            const groupedItems = items.reduce((acc, item) => {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});

            container.innerHTML = config.categories.map(categoryName => {
                if (!groupedItems[categoryName]) return '';

                const categoryItems = groupedItems[categoryName];
                const allVerified = categoryItems.every(item => state.itemStatus[item.id] === "verified");
                const hasPhoto = state.rackPhotos[state.activeRack] ? '<span style="color: var(--success-color);">📸</span>' : '';
                
                 return `
                    <div class="detail-rack-group">
                        <h3 id="detail-rack-${sanitizeForId(categoryName)}">
                            <label class="detail-rack-group-title" data-category-id="${categoryName}">
                                <input type="checkbox" class="rack-master-check" data-rack-id="${state.activeRack}" data-category-id="${categoryName}" ${allVerified ? "checked" : ""}>
                                <span>${categoryName} <span class="rack-photo-indicator" data-rack-id="${state.activeRack}">${hasPhoto}</span></span>
                            </label>
                             <div class="rack-controls">
                                <button class="rack-photo-btn" data-rack-id="${state.activeRack}" title="Add or View Rack Photo">📷 Photo</button>
                                <button class="rack-reset-btn" data-rack-id="${state.activeRack}" title="Reset Progress for ${state.activeRack}">🔄 Reset</button>
                            </div>
                        </h3>
                        <ul class="equipment-list">${categoryItems.map(generateItemHTML).join('')}</ul>
                    </div>`;

            }).join('') || '<div class="no-selection">No items match your selection or search.</div>';
        }

        // --- SHARED ITEM RENDERING ---
        function updateItemUI(itemId) {
            const item = config.allItems[itemId];
            if (!item) return;
            const desktopEl = document.getElementById(`item-${item.id}`);
            const mobileEl = document.getElementById(`mobile-item-${item.id}`);
            if (desktopEl) desktopEl.outerHTML = generateItemHTML(item);
            if (mobileEl) mobileEl.outerHTML = generateMobileItemHTML(item);
        }

        function generateItemHTML(item) {
            const status = state.itemStatus[item.id] || "pending";
            const note = state.itemNotes[item.id];
            const timestamp = state.itemTimestamps[item.id];
            
            const deviceType = getDeviceType(item);
            let deviceControls = '';
            let hasData = false;
            
            if (deviceType === 'server') {
                const deviceData = state.deviceData?.[item.rack]?.[item.title] || {};
                deviceControls = `
                    <button class="data-btn ${deviceData.serial ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="serial" title="Serial Number">S/N</button>
                    <button class="data-btn ${deviceData.ilo ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="ilo" title="ILO Password">ILO</button>`;
            } else if (deviceType === 'network') {
                const deviceData = state.deviceData?.[item.rack]?.[item.title] || {};
                deviceControls = `
                    <button class="data-btn ${deviceData.serial ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="serial" title="Serial Number">S/N</button>
                    <button class="data-btn ${deviceData.mac ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="mac" title="MAC Address">MAC</button>`;
            } else if (deviceType === 'cable') {
                const cableData = state.itemData?.[item.id] || {};
                deviceControls = `<button class="data-btn ${cableData.cableId ? 'has-data' : ''}" data-item-id="${item.id}" data-field="cableId" title="Cable ID">ID</button>`;
            }

            return `
                <li class="equipment-list-item" id="item-${item.id}">
                    <div class="equipment-header">
                        <div class="title">${escapeHTML(item.title)}</div>
                        <div class="item-controls">
                            ${deviceControls}
                            <button class="note-btn" data-item-id="${item.id}" title="Add note">🗒️</button>
                            <div class="status-toggle ${status}" data-item-id="${item.id}" title="Cycle status: ${status}" role="button" tabindex="0">${getStatusIcon(status)}</div>
                        </div>
                    </div>
                    ${item.details ? `<div class="equipment-details">${escapeHTML(item.details)}</div>` : ''}
                    ${note ? `<div class="item-note">Note: ${escapeHTML(note)}</div>` : ""}
                    ${timestamp ? `<div style="font-size: 0.8em; color: var(--border-color); margin-top: 0.5rem;">Updated: ${new Date(timestamp).toLocaleString()}</div>` : ""}
                </li>`;
        }
        
        function getDeviceType(item) {
            const title = item.title.toLowerCase();
            const category = item.category.toLowerCase();
            if (title.includes('server')) return 'server';
            if (['spine', 'fw', 'agg', 'tor', 'bor'].some(term => title.includes(term))) return 'network';
            if (category.includes('fiber optic') || category.includes('utp')) return 'cable';
            return 'other';
        }
        // #endregion
        
        // #region MOBILE RENDERING
        function renderMobile() {
            document.getElementById("mobile-panel-main").classList.toggle("active", state.mobileView === "main");
            document.getElementById("mobile-panel-items").classList.toggle("active", state.mobileView === "items");

            if (state.mobileView === 'main') {
                renderMobileMainList();
            } else if (state.mobileView === 'items') {
                renderMobileItemList();
            }
        }

        function renderMobileMainList() {
            const container = document.getElementById("mobile-main-list");
            if (!container) return;
            updateOverallStatsUI();

            container.innerHTML = config.categories.map(categoryName => {
                const racksForCategory = Object.keys(config.racks).filter(rackId => 
                    state.selectedRacks[rackId] && config.racks[rackId].items.some(item => item.category === categoryName)
                );
                if (racksForCategory.length === 0) return '';
                
                let categoryHtml = `<li class="mobile-main-category-header">${categoryName}</li>`;
                categoryHtml += racksForCategory.map(rackId => {
                    const progress = getRackProgress(rackId, categoryName);
                    const percentage = progress.total > 0 ? Math.round(progress.verified / progress.total * 100) : 0;
                    const status = getCategoryStatus(progress);
                    
                    return `
                        <li class="mobile-rack-item" data-rack-id="${rackId}" data-category-id="${categoryName}">
                            <div class="rack-list-item-main" role="button" tabindex="0">
                                <span class="status-icon ${status}">${getStatusIcon(status)}</span>
                                <span class="rack-name">${rackId.split(" ")[0]}</span>
                                <div class="rack-progress-bar"><div class="rack-progress-fill" style="width:${percentage}%;"></div></div>
                                <span class="percentage">${percentage}%</span>
                            </div>
                        </li>`;
                }).join('');
                return categoryHtml;
            }).join('');
        }

        function renderMobileItemList() {
            const container = document.getElementById("mobile-item-list");
            if (!container || !state.mobileRack || !state.activeCategory) return;

            document.getElementById("mobile-item-title").textContent = `${state.mobileRack.split(" ")[0]} - ${state.activeCategory}`;
            const searchTerm = state.searchTerm.toLowerCase();
            const items = config.racks[state.mobileRack].items.filter(item => 
                item.category === state.activeCategory &&
                (!searchTerm || item.title.toLowerCase().includes(searchTerm) || item.details.toLowerCase().includes(searchTerm))
            );

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color-subtle); border-radius: 4px;">
                    <div style="display: flex; justify-content: space-around; align-items: center;">
                        <button class="btn mobile-rack-photo-btn" data-rack-id="${state.mobileRack}">📷 Photo</button>
                        <button class="btn btn-secondary mobile-rack-reset-btn" data-rack-id="${state.mobileRack}">🔄 Reset</button>
                    </div>
                </div>`;
            html += items.map(generateMobileItemHTML).join('');
            container.innerHTML = html || '<div class="no-selection">No items match.</div>';
        }
        
        function generateMobileItemHTML(item) {
            const status = state.itemStatus[item.id] || "pending";
            const note = state.itemNotes[item.id];
            
            const deviceType = getDeviceType(item);
            let deviceControls = '';
            
            if (deviceType === 'server') {
                const deviceData = state.deviceData?.[item.rack]?.[item.title] || {};
                deviceControls = `<button class="data-btn ${deviceData.serial ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="serial">S/N</button>
                                  <button class="data-btn ${deviceData.ilo ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="ilo">ILO</button>`;
            } else if (deviceType === 'network') {
                const deviceData = state.deviceData?.[item.rack]?.[item.title] || {};
                deviceControls = `<button class="data-btn ${deviceData.serial ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="serial">S/N</button>
                                  <button class="data-btn ${deviceData.mac ? 'has-data' : ''}" data-item-id="${item.id}" data-device-name="${escapeHTML(item.title)}" data-rack-id="${item.rack}" data-field="mac">MAC</button>`;
            } else if (deviceType === 'cable') {
                const cableData = state.itemData?.[item.id] || {};
                deviceControls = `<button class="data-btn ${cableData.cableId ? 'has-data' : ''}" data-item-id="${item.id}" data-field="cableId">ID</button>`;
            }

            return `
                <div class="mobile-equipment-item" id="mobile-item-${item.id}">
                    <div class="mobile-equipment-header">
                        <div class="mobile-equipment-title">${escapeHTML(item.title)}</div>
                        <div class="mobile-equipment-controls">
                            ${deviceControls}
                            <button class="note-btn" data-item-id="${item.id}" title="Add note">🗒️</button>
                            <div class="mobile-status-toggle ${status}" data-item-id="${item.id}" role="button" tabindex="0">${getStatusIcon(status)}</div>
                        </div>
                    </div>
                    ${item.details ? `<div class="equipment-details">${escapeHTML(item.details)}</div>` : ''}
                    ${note ? `<div class="item-note">Note: ${escapeHTML(note)}</div>` : ""}
                </div>`;
        }
        // #endregion
        
        // #region EVENT HANDLING & USER ACTIONS
        function setupEventListeners() {
            document.body.addEventListener('click', handleBodyClick);
            document.body.addEventListener('change', handleBodyChange);
            document.body.addEventListener('keydown', handleBodyKeydown);

            const searchInput = document.getElementById("search-input");
            searchInput.addEventListener("input", debounce(e => {
                state.searchTerm = e.target.value;
                renderAppLayout();
            }, 300));
            
            const mobileSearchInput = document.getElementById("mobile-search-input");
            mobileSearchInput.addEventListener("input", debounce(e => {
                state.searchTerm = e.target.value;
                renderMobile();
            }, 300));

            window.addEventListener('online', () => { state.isOnline = true; updateOnlineStatus(); });
            window.addEventListener('offline', () => { state.isOnline = false; updateOnlineStatus(); });
        }

        function handleBodyClick(e) {
            const target = e.target;
            
            // Haptic feedback for interactive elements
            if (target.closest('.btn, .sidebar-list-item, .mobile-rack-item, .mobile-status-toggle, .note-btn, .data-btn, .photo-btn')) {
                triggerVibration();
            }

            // --- View Mode ---
            if (target.id === 'view-mode-category-btn') { setViewMode('category'); return; }
            if (target.id === 'view-mode-rack-btn') { setViewMode('rack'); return; }

            // --- Modals, Overlays, Global Controls ---
            if (target.closest('#show-instructions-btn, #mobile-show-instructions-btn')) { showInstructionsModal(); return; }
            if (target.id === 'mobile-filter-racks-btn') {
                modal.show({
                    title: 'Filter by Rack',
                    body: '<div id="modal-rack-selector" class="rack-selector-container"></div>',
                    footerButtons: [{ label: 'Done', className: 'btn', onClick: () => modal.hide() }]
                });
                renderRackSelector();
                return;
            }
            if (target.closest('.modal-close-btn')) { modal.hide(); return; }
            if (target.id === 'mobile-search-btn') {
                document.getElementById('search-overlay').classList.add('is-visible');
                document.getElementById('mobile-search-input').focus();
                return;
            }
            if (target.id === 'close-search-overlay-btn') { document.getElementById('search-overlay').classList.remove('is-visible'); return; }
            if (target.id === 'clear-search-btn') {
                document.getElementById("search-input").value = '';
                state.searchTerm = '';
                renderAppLayout();
                return;
            }
            if (target.closest('#export-yaml-btn, #mobile-export-yaml-btn')) { exportYAML(); return; }
            if (target.closest('#export-csv-btn, #mobile-export-csv-btn')) { exportCSV(); return; }
            if (target.id === 'import-btn') { importState(); return; }
            if (target.closest('#backup-btn, #mobile-backup-btn')) { createBackup(); return; }
            if (target.closest('#reset-all-btn, #mobile-reset-all-btn')) { resetAllProgress(); return; }

            // --- Context-Specific Actions ---
            const dataBtn = target.closest(".data-btn");
            if (dataBtn) { openItemDataModal(dataBtn.dataset.itemId); return; }

            const statusToggle = target.closest(".status-toggle, .mobile-status-toggle");
            if (statusToggle) { toggleItemStatus(statusToggle.dataset.itemId); return; }

            const noteBtn = target.closest(".note-btn");
            if (noteBtn) { promptForNote(noteBtn.dataset.itemId); return; }
            
            const rackPhotoBtn = target.closest(".rack-photo-btn, .mobile-rack-photo-btn");
            if (rackPhotoBtn) { handleRackPhoto(rackPhotoBtn.dataset.rackId); return; }
        
            const rackResetBtn = target.closest(".rack-reset-btn, .mobile-rack-reset-btn");
            if (rackResetBtn) { resetRackProgress(rackResetBtn.dataset.rackId); return; }
            
            // --- Navigation ---
            const sidebarItem = target.closest("#sidebar-list .sidebar-list-item");
            if (sidebarItem) {
                if (sidebarItem.dataset.categoryId) selectCategory(sidebarItem.dataset.categoryId);
                if (sidebarItem.dataset.rackId) selectRack(sidebarItem.dataset.rackId);
                return;
            }
            
            const rackOverviewItem = target.closest(".desktop-view .rack-list-item-main");
            if (rackOverviewItem) { scrollToRack(rackOverviewItem.dataset.rackId); return; }
            
            const mobileRackItem = target.closest(".mobile-rack-item");
            if (mobileRackItem) {
                selectCategoryAndRackForMobile(mobileRackItem.dataset.categoryId, mobileRackItem.dataset.rackId);
                return;
            }

            const mobileBackBtn = target.closest(".mobile-back-btn");
            if (mobileBackBtn) { setMobileView('main'); return; }
        }

        function handleBodyChange(e) {
            const target = e.target;
            if (target.closest(".rack-selector-container") && target.type === 'checkbox') {
                updateRackSelection(target.value, target.checked);
            }
            if (target.classList.contains('rack-master-check')) {
                toggleAllItemsInGroup(target.dataset.rackId, target.dataset.categoryId, target.checked);
            }
        }

        function handleBodyKeydown(e) {
             if (e.key === 'Escape' && document.querySelector('.modal-overlay.is-visible')) { modal.hide(); }
             if ((e.key === 'Enter' || e.key === ' ') && e.target.closest('[role="button"]')) { e.preventDefault(); e.target.click(); }
             if (e.ctrlKey || e.metaKey) {
                 if (e.key === 'f') { e.preventDefault(); document.getElementById("search-input").focus(); }
             }
        }
        
        function setViewMode(mode) {
            if (state.viewMode === mode) return;
            state.viewMode = mode;
            saveState();
            updateUI({ viewModeChange: true });
        }

        function selectCategory(categoryId) {
            state.activeCategory = categoryId;
            saveState();
            updateUI({ all: true });
        }
        
        function selectRack(rackId) {
            state.activeRack = rackId;
            saveState();
            updateUI({ all: true });
        }
        
        function selectCategoryAndRackForMobile(categoryId, rackId) {
            state.activeCategory = categoryId;
            state.mobileRack = rackId;
            setMobileView("items");
        }

        function setMobileView(view) {
            state.mobileView = view;
            saveState();
            renderMobile();
        }

        function toggleItemStatus(itemId) {
            const currentStatus = state.itemStatus[itemId] || "pending";
            const nextStatus = statusCycle[(statusCycle.indexOf(currentStatus) + 1) % statusCycle.length];
            if (nextStatus === "pending") {
                delete state.itemStatus[itemId];
                delete state.itemTimestamps[itemId];
            } else {
                state.itemStatus[itemId] = nextStatus;
                state.itemTimestamps[itemId] = new Date().toISOString();
            }
            saveState();
            const item = config.allItems[itemId];
            updateUI({ item: itemId, category: item.category, rack: item.rack });
        }

        function toggleAllItemsInGroup(rackId, categoryId, isChecked) {
            const items = config.racks[rackId].items.filter(item => 
                state.viewMode === 'rack' ? item.category === categoryId : item.category === state.activeCategory
            );
            items.forEach(item => {
                if (isChecked) {
                    state.itemStatus[item.id] = "verified";
                    state.itemTimestamps[item.id] = new Date().toISOString();
                } else {
                    delete state.itemStatus[item.id];
                    delete state.itemTimestamps[item.id];
                }
            });
            saveState();
            renderAppLayout();
        }

        function updateRackSelection(rackId, isChecked) {
            if (rackId === "all") {
                Object.keys(config.racks).forEach(id => state.selectedRacks[id] = isChecked);
            } else {
                state.selectedRacks[rackId] = isChecked;
            }
            saveState();
            updateUI({ all: true });
        }

        function scrollToRack(rackId) {
            const element = document.getElementById(`detail-rack-${sanitizeForId(rackId)}`);
            if (element) {
                element.scrollIntoView({ behavior: "smooth", block: "start" });
                element.focus();
            }
        }
        
        function promptForNote(itemId) {
            const item = config.allItems[itemId];
            const currentNote = state.itemNotes[itemId] || "";
            const bodyHtml = `
                <div class="form-group">
                    <label for="item-note-input">Note for: ${escapeHTML(item.title)}</label>
                    <textarea id="item-note-input">${escapeHTML(currentNote)}</textarea>
                </div>`;
            modal.show({
                title: 'Edit Note',
                body: bodyHtml,
                footerButtons: [{
                    label: 'Save',
                    className: 'btn',
                    onClick: () => {
                        const newNote = document.getElementById('item-note-input').value.trim();
                        if (newNote) {
                            state.itemNotes[itemId] = newNote;
                        } else {
                            delete state.itemNotes[itemId];
                        }
                        saveState();
                        updateUI({ item: itemId });
                        modal.hide();
                    }
                }]
            });
            setTimeout(() => document.getElementById('item-note-input').focus(), 100);
        }
        
        function resetRackProgress(rackId) {
            modal.show({
                title: `Reset progress for ${rackId}?`,
                body: `<p>Are you sure you want to reset all progress, notes, and data for rack <strong>${rackId}</strong>? This cannot be undone.</p>`,
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    {
                        label: 'Reset',
                        className: 'btn',
                        onClick: () => {
                            config.racks[rackId].items.forEach(item => {
                                delete state.itemStatus[item.id];
                                delete state.itemNotes[item.id];
                                delete state.itemTimestamps[item.id];
                                if (state.itemData) delete state.itemData[item.id];
                            });
                            if (state.deviceData) delete state.deviceData[rackId];
                            saveState();
                            showNotification(`Progress reset for rack ${rackId}`, "success");
                            modal.hide();
                            if (state.mobileView === 'items') setMobileView('main');
                            renderAppLayout();
                        }
                    }
                ]
            });
        }

        function resetAllProgress() {
            modal.show({
                title: "Reset All Progress?",
                body: '<p>Are you sure? This will clear <strong>ALL</strong> statuses, notes, photos, and data across all racks. This action cannot be undone.</p>',
                footerButtons: [
                    { label: 'Cancel', className: 'btn-secondary', onClick: () => modal.hide() },
                    {
                        label: 'Reset Everything',
                        className: 'btn',
                        onClick: () => {
                            state.itemStatus = {};
                            state.itemNotes = {};
                            state.itemTimestamps = {};
                            state.itemData = {};
                            state.deviceData = {};
                            state.rackPhotos = {};
                            saveState();
                            updateUI({ all: true });
                            showNotification("All progress has been reset", "success");
                            modal.hide();
                        }
                    }
                ]
            });
        }
        // #endregion

        // #region DATA I/O
        function exportYAML() {
            try {
                const yamlString = jsyaml.dump({
                    metadata: { timestamp: new Date().toISOString(), version: config.version, technician: state.technicianId },
                    progress: getCategoryProgress(),
                    state: state
                });
                downloadBlob(new Blob([yamlString], { type: "text/yaml" }), `dc_checklist_${new Date().toISOString().split('T')[0]}.yaml`);
                showNotification("Exported as YAML", "success");
            } catch (e) {
                showNotification("YAML Export failed", "error");
            }
        }

        function exportCSV() {
            try {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Rack,Category,Title,Status,Notes,SerialNumber,MACAddress,ILOPassword,CableID\r\n";
                Object.values(config.allItems).forEach(item => {
                    const status = state.itemStatus[item.id] || "pending";
                    const notes = state.itemNotes[item.id] || "";
                    const itemType = getDeviceType(item);
                    let data = {};
                    if(itemType === 'server' || itemType === 'network'){
                        data = state.deviceData?.[item.rack]?.[item.title] || {};
                    } else if (itemType === 'cable') {
                        data = state.itemData?.[item.id] || {};
                    }
                    const row = [
                        item.id, item.rack, item.category, `"${item.title.replace(/"/g, '""')}"`,
                        status, `"${notes.replace(/"/g, '""')}"`,
                        data.serial || "", data.mac || "", data.ilo || "", data.cableId || ""
                    ].join(",");
                    csvContent += row + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `dc_checklist_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
                showNotification("Exported as CSV", "success");
            } catch (e) {
                showNotification("CSV Export failed", "error");
            }
        }

        function importState() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.yaml,.yml';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let importData;
                        if (file.name.endsWith('.yaml') || file.name.endsWith('.yml')) {
                            importData = jsyaml.load(e.target.result);
                        } else {
                            importData = JSON.parse(e.target.result);
                        }
                        
                        if (importData.state && typeof importData.state.itemStatus === 'object') {
                            state = { ...state, ...importData.state };
                            saveState();
                            updateUI({ all: true });
                            showNotification("Progress imported successfully", "success");
                        } else {
                            throw new Error("Invalid file format");
                        }
                    } catch (error) {
                        showNotification("Import failed: Invalid file", "error");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function createBackup() {
            localStorage.setItem(`dcChecklistBackup_${Date.now()}`, JSON.stringify({ timestamp: new Date().toISOString(), state: state }));
            showNotification("Backup created", "success");
            const keys = Object.keys(localStorage).filter(key => key.startsWith('dcChecklistBackup_'));
            keys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
        }
        // #endregion

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
